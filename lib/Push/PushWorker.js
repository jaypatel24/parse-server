'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.PushWorker = undefined;

var _deepcopy = require('deepcopy');

var _deepcopy2 = _interopRequireDefault(_deepcopy);

var _AdaptableController = require('../Controllers/AdaptableController');

var _AdaptableController2 = _interopRequireDefault(_AdaptableController);

var _Auth = require('../Auth');

var _Config = require('../Config');

var _Config2 = _interopRequireDefault(_Config);

var _PushAdapter = require('../Adapters/Push/PushAdapter');

var _rest = require('../rest');

var _rest2 = _interopRequireDefault(_rest);

var _StatusHandler = require('../StatusHandler');

var _utils = require('./utils');

var utils = _interopRequireWildcard(_utils);

var _ParseMessageQueue = require('../ParseMessageQueue');

var _PushQueue = require('./PushQueue');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function groupByBadge(installations) {
  return installations.reduce((map, installation) => {
    const badge = installation.badge + '';
    map[badge] = map[badge] || [];
    map[badge].push(installation);
    return map;
  }, {});
}
// -disable-next
class PushWorker {

  constructor(pushAdapter, subscriberConfig = {}) {
    _AdaptableController2.default.validateAdapter(pushAdapter, this, _PushAdapter.PushAdapter);
    this.adapter = pushAdapter;

    this.channel = subscriberConfig.channel || _PushQueue.PushQueue.defaultPushChannel();
    this.subscriber = _ParseMessageQueue.ParseMessageQueue.createSubscriber(subscriberConfig);
    if (this.subscriber) {
      const subscriber = this.subscriber;
      subscriber.subscribe(this.channel);
      subscriber.on('message', (channel, messageStr) => {
        const workItem = JSON.parse(messageStr);
        this.run(workItem);
      });
    }
  }

  run({ body, query, pushStatus, applicationId, UTCOffset }) {
    const config = _Config2.default.get(applicationId);
    const auth = (0, _Auth.master)(config);
    const where = utils.applyDeviceTokenExists(query.where);
    delete query.where;
    pushStatus = (0, _StatusHandler.pushStatusHandler)(config, pushStatus.objectId);
    return _rest2.default.find(config, auth, '_Installation', where, query).then(({ results }) => {
      if (results.length == 0) {
        return;
      }
      return this.sendToAdapter(body, results, pushStatus, config, UTCOffset);
    });
  }

  sendToAdapter(body, installations, pushStatus, config, UTCOffset) {
    // Check if we have locales in the push body
    const locales = utils.getLocalesFromPush(body);
    if (locales.length > 0) {
      // Get all tranformed bodies for each locale
      const bodiesPerLocales = utils.bodiesPerLocales(body, locales);

      // Group installations on the specified locales (en, fr, default etc...)
      const grouppedInstallations = utils.groupByLocaleIdentifier(installations, locales);
      const promises = Object.keys(grouppedInstallations).map(locale => {
        const installations = grouppedInstallations[locale];
        const body = bodiesPerLocales[locale];
        return this.sendToAdapter(body, installations, pushStatus, config, UTCOffset);
      });
      return Promise.all(promises);
    }

    if (!utils.isPushIncrementing(body)) {
      _logger2.default.verbose(`Sending push to ${installations.length}`);
      return this.adapter.send(body, installations, pushStatus.objectId).then(results => {
        return pushStatus.trackSent(results, UTCOffset).then(() => results);
      });
    }

    // Collect the badges to reduce the # of calls
    const badgeInstallationsMap = groupByBadge(installations);

    // Map the on the badges count and return the send result
    const promises = Object.keys(badgeInstallationsMap).map(badge => {
      const payload = (0, _deepcopy2.default)(body);
      payload.data.badge = parseInt(badge);
      const installations = badgeInstallationsMap[badge];
      return this.sendToAdapter(payload, installations, pushStatus, config, UTCOffset);
    });
    return Promise.all(promises);
  }
}

exports.PushWorker = PushWorker;
exports.default = PushWorker;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QdXNoL1B1c2hXb3JrZXIuanMiXSwibmFtZXMiOlsidXRpbHMiLCJncm91cEJ5QmFkZ2UiLCJpbnN0YWxsYXRpb25zIiwicmVkdWNlIiwibWFwIiwiaW5zdGFsbGF0aW9uIiwiYmFkZ2UiLCJwdXNoIiwiUHVzaFdvcmtlciIsImNvbnN0cnVjdG9yIiwicHVzaEFkYXB0ZXIiLCJzdWJzY3JpYmVyQ29uZmlnIiwidmFsaWRhdGVBZGFwdGVyIiwiYWRhcHRlciIsImNoYW5uZWwiLCJkZWZhdWx0UHVzaENoYW5uZWwiLCJzdWJzY3JpYmVyIiwiY3JlYXRlU3Vic2NyaWJlciIsInN1YnNjcmliZSIsIm9uIiwibWVzc2FnZVN0ciIsIndvcmtJdGVtIiwiSlNPTiIsInBhcnNlIiwicnVuIiwiYm9keSIsInF1ZXJ5IiwicHVzaFN0YXR1cyIsImFwcGxpY2F0aW9uSWQiLCJVVENPZmZzZXQiLCJjb25maWciLCJnZXQiLCJhdXRoIiwid2hlcmUiLCJhcHBseURldmljZVRva2VuRXhpc3RzIiwib2JqZWN0SWQiLCJmaW5kIiwidGhlbiIsInJlc3VsdHMiLCJsZW5ndGgiLCJzZW5kVG9BZGFwdGVyIiwibG9jYWxlcyIsImdldExvY2FsZXNGcm9tUHVzaCIsImJvZGllc1BlckxvY2FsZXMiLCJncm91cHBlZEluc3RhbGxhdGlvbnMiLCJncm91cEJ5TG9jYWxlSWRlbnRpZmllciIsInByb21pc2VzIiwiT2JqZWN0Iiwia2V5cyIsImxvY2FsZSIsIlByb21pc2UiLCJhbGwiLCJpc1B1c2hJbmNyZW1lbnRpbmciLCJ2ZXJib3NlIiwic2VuZCIsInRyYWNrU2VudCIsImJhZGdlSW5zdGFsbGF0aW9uc01hcCIsInBheWxvYWQiLCJkYXRhIiwicGFyc2VJbnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFFQTs7OztBQUNBOzs7O0FBQ0E7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7OztBQUNBOztBQUNBOztJQUFZQSxLOztBQUNaOztBQUNBOztBQUNBOzs7Ozs7OztBQUVB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QVlMLFFBQVosQ0FBUDtBQUNEO0FBdEVxQjs7UUFBWHRDLFUsR0FBQUEsVTtrQkF5RUVBLFUiLCJmaWxlIjoiUHVzaFdvcmtlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEBmbG93XG4vLyBAZmxvdy1kaXNhYmxlLW5leHRcbmltcG9ydCBkZWVwY29weSAgICAgICAgICAgICAgIGZyb20gJ2RlZXBjb3B5JztcbmltcG9ydCBBZGFwdGFibGVDb250cm9sbGVyICAgIGZyb20gJy4uL0NvbnRyb2xsZXJzL0FkYXB0YWJsZUNvbnRyb2xsZXInO1xuaW1wb3J0IHsgbWFzdGVyIH0gICAgICAgICAgICAgZnJvbSAnLi4vQXV0aCc7XG5pbXBvcnQgQ29uZmlnICAgICAgICAgICAgICAgICBmcm9tICcuLi9Db25maWcnO1xuaW1wb3J0IHsgUHVzaEFkYXB0ZXIgfSAgICAgICAgZnJvbSAnLi4vQWRhcHRlcnMvUHVzaC9QdXNoQWRhcHRlcic7XG5pbXBvcnQgcmVzdCAgICAgICAgICAgICAgICAgICBmcm9tICcuLi9yZXN0JztcbmltcG9ydCB7IHB1c2hTdGF0dXNIYW5kbGVyIH0gIGZyb20gJy4uL1N0YXR1c0hhbmRsZXInO1xuaW1wb3J0ICogYXMgdXRpbHMgICAgICAgICAgICAgZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgeyBQYXJzZU1lc3NhZ2VRdWV1ZSB9ICBmcm9tICcuLi9QYXJzZU1lc3NhZ2VRdWV1ZSc7XG5pbXBvcnQgeyBQdXNoUXVldWUgfSAgICAgICAgICBmcm9tICcuL1B1c2hRdWV1ZSc7XG5pbXBvcnQgbG9nZ2VyICAgICAgICAgICAgICAgICBmcm9tICcuLi9sb2dnZXInO1xuXG5mdW5jdGlvbiBncm91cEJ5QmFkZ2UoaW5zdGFsbGF0aW9ucykge1xuICByZXR1cm4gaW5zdGFsbGF0aW9ucy5yZWR1Y2UoKG1hcCwgaW5zdGFsbGF0aW9uKSA9PiB7XG4gICAgY29uc3QgYmFkZ2UgPSBpbnN0YWxsYXRpb24uYmFkZ2UgKyAnJztcbiAgICBtYXBbYmFkZ2VdID0gbWFwW2JhZGdlXSB8fCBbXTtcbiAgICBtYXBbYmFkZ2VdLnB1c2goaW5zdGFsbGF0aW9uKTtcbiAgICByZXR1cm4gbWFwO1xuICB9LCB7fSk7XG59XG5cbmV4cG9ydCBjbGFzcyBQdXNoV29ya2VyIHtcbiAgc3Vic2NyaWJlcjogP2FueTtcbiAgYWRhcHRlcjogYW55O1xuICBjaGFubmVsOiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IocHVzaEFkYXB0ZXI6IFB1c2hBZGFwdGVyLCBzdWJzY3JpYmVyQ29uZmlnOiBhbnkgPSB7fSkge1xuICAgIEFkYXB0YWJsZUNvbnRyb2xsZXIudmFsaWRhdGVBZGFwdGVyKHB1c2hBZGFwdGVyLCB0aGlzLCBQdXNoQWRhcHRlcik7XG4gICAgdGhpcy5hZGFwdGVyID0gcHVzaEFkYXB0ZXI7XG5cbiAgICB0aGlzLmNoYW5uZWwgPSBzdWJzY3JpYmVyQ29uZmlnLmNoYW5uZWwgfHwgUHVzaFF1ZXVlLmRlZmF1bHRQdXNoQ2hhbm5lbCgpO1xuICAgIHRoaXMuc3Vic2NyaWJlciA9IFBhcnNlTWVzc2FnZVF1ZXVlLmNyZWF0ZVN1YnNjcmliZXIoc3Vic2NyaWJlckNvbmZpZyk7XG4gICAgaWYgKHRoaXMuc3Vic2NyaWJlcikge1xuICAgICAgY29uc3Qgc3Vic2NyaWJlciA9IHRoaXMuc3Vic2NyaWJlcjtcbiAgICAgIHN1YnNjcmliZXIuc3Vic2NyaWJlKHRoaXMuY2hhbm5lbCk7XG4gICAgICBzdWJzY3JpYmVyLm9uKCdtZXNzYWdlJywgKGNoYW5uZWwsIG1lc3NhZ2VTdHIpID0+IHtcbiAgICAgICAgY29uc3Qgd29ya0l0ZW0gPSBKU09OLnBhcnNlKG1lc3NhZ2VTdHIpO1xuICAgICAgICB0aGlzLnJ1bih3b3JrSXRlbSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBydW4oeyBib2R5LCBxdWVyeSwgcHVzaFN0YXR1cywgYXBwbGljYXRpb25JZCwgVVRDT2Zmc2V0IH06IGFueSk6IFByb21pc2U8Kj4ge1xuICAgIGNvbnN0IGNvbmZpZyA9IENvbmZpZy5nZXQoYXBwbGljYXRpb25JZCk7XG4gICAgY29uc3QgYXV0aCA9IG1hc3Rlcihjb25maWcpO1xuICAgIGNvbnN0IHdoZXJlID0gdXRpbHMuYXBwbHlEZXZpY2VUb2tlbkV4aXN0cyhxdWVyeS53aGVyZSk7XG4gICAgZGVsZXRlIHF1ZXJ5LndoZXJlO1xuICAgIHB1c2hTdGF0dXMgPSBwdXNoU3RhdHVzSGFuZGxlcihjb25maWcsIHB1c2hTdGF0dXMub2JqZWN0SWQpO1xuICAgIHJldHVybiByZXN0LmZpbmQoY29uZmlnLCBhdXRoLCAnX0luc3RhbGxhdGlvbicsIHdoZXJlLCBxdWVyeSkudGhlbigoe3Jlc3VsdHN9KSA9PiB7XG4gICAgICBpZiAocmVzdWx0cy5sZW5ndGggPT0gMCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICByZXR1cm4gdGhpcy5zZW5kVG9BZGFwdGVyKGJvZHksIHJlc3VsdHMsIHB1c2hTdGF0dXMsIGNvbmZpZywgVVRDT2Zmc2V0KTtcbiAgICB9KTtcbiAgfVxuXG4gIHNlbmRUb0FkYXB0ZXIoYm9keTogYW55LCBpbnN0YWxsYXRpb25zOiBhbnlbXSwgcHVzaFN0YXR1czogYW55LCBjb25maWc6IENvbmZpZywgVVRDT2Zmc2V0OiA/YW55KTogUHJvbWlzZTwqPiB7XG4gICAgLy8gQ2hlY2sgaWYgd2UgaGF2ZSBsb2NhbGVzIGluIHRoZSBwdXNoIGJvZHlcbiAgICBjb25zdCBsb2NhbGVzID0gdXRpbHMuZ2V0TG9jYWxlc0Zyb21QdXNoKGJvZHkpO1xuICAgIGlmIChsb2NhbGVzLmxlbmd0aCA+IDApIHtcbiAgICAgIC8vIEdldCBhbGwgdHJhbmZvcm1lZCBib2RpZXMgZm9yIGVhY2ggbG9jYWxlXG4gICAgICBjb25zdCBib2RpZXNQZXJMb2NhbGVzID0gdXRpbHMuYm9kaWVzUGVyTG9jYWxlcyhib2R5LCBsb2NhbGVzKTtcblxuICAgICAgLy8gR3JvdXAgaW5zdGFsbGF0aW9ucyBvbiB0aGUgc3BlY2lmaWVkIGxvY2FsZXMgKGVuLCBmciwgZGVmYXVsdCBldGMuLi4pXG4gICAgICBjb25zdCBncm91cHBlZEluc3RhbGxhdGlvbnMgPSB1dGlscy5ncm91cEJ5TG9jYWxlSWRlbnRpZmllcihpbnN0YWxsYXRpb25zLCBsb2NhbGVzKTtcbiAgICAgIGNvbnN0IHByb21pc2VzID0gT2JqZWN0LmtleXMoZ3JvdXBwZWRJbnN0YWxsYXRpb25zKS5tYXAoKGxvY2FsZSkgPT4ge1xuICAgICAgICBjb25zdCBpbnN0YWxsYXRpb25zID0gZ3JvdXBwZWRJbnN0YWxsYXRpb25zW2xvY2FsZV07XG4gICAgICAgIGNvbnN0IGJvZHkgPSBib2RpZXNQZXJMb2NhbGVzW2xvY2FsZV07XG4gICAgICAgIHJldHVybiB0aGlzLnNlbmRUb0FkYXB0ZXIoYm9keSwgaW5zdGFsbGF0aW9ucywgcHVzaFN0YXR1cywgY29uZmlnLCBVVENPZmZzZXQpO1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpO1xuICAgIH1cblxuICAgIGlmICghdXRpbHMuaXNQdXNoSW5jcmVtZW50aW5nKGJvZHkpKSB7XG4gICAgICBsb2dnZXIudmVyYm9zZShgU2VuZGluZyBwdXNoIHRvICR7aW5zdGFsbGF0aW9ucy5sZW5ndGh9YCk7XG4gICAgICByZXR1cm4gdGhpcy5hZGFwdGVyLnNlbmQoYm9keSwgaW5zdGFsbGF0aW9ucywgcHVzaFN0YXR1cy5vYmplY3RJZCkudGhlbigocmVzdWx0cykgPT4ge1xuICAgICAgICByZXR1cm4gcHVzaFN0YXR1cy50cmFja1NlbnQocmVzdWx0cywgVVRDT2Zmc2V0KS50aGVuKCgpID0+IHJlc3VsdHMpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQ29sbGVjdCB0aGUgYmFkZ2VzIHRvIHJlZHVjZSB0aGUgIyBvZiBjYWxsc1xuICAgIGNvbnN0IGJhZGdlSW5zdGFsbGF0aW9uc01hcCA9IGdyb3VwQnlCYWRnZShpbnN0YWxsYXRpb25zKTtcblxuICAgIC8vIE1hcCB0aGUgb24gdGhlIGJhZGdlcyBjb3VudCBhbmQgcmV0dXJuIHRoZSBzZW5kIHJlc3VsdFxuICAgIGNvbnN0IHByb21pc2VzID0gT2JqZWN0LmtleXMoYmFkZ2VJbnN0YWxsYXRpb25zTWFwKS5tYXAoKGJhZGdlKSA9PiB7XG4gICAgICBjb25zdCBwYXlsb2FkID0gZGVlcGNvcHkoYm9keSk7XG4gICAgICBwYXlsb2FkLmRhdGEuYmFkZ2UgPSBwYXJzZUludChiYWRnZSk7XG4gICAgICBjb25zdCBpbnN0YWxsYXRpb25zID0gYmFkZ2VJbnN0YWxsYXRpb25zTWFwW2JhZGdlXTtcbiAgICAgIHJldHVybiB0aGlzLnNlbmRUb0FkYXB0ZXIocGF5bG9hZCwgaW5zdGFsbGF0aW9ucywgcHVzaFN0YXR1cywgY29uZmlnLCBVVENPZmZzZXQpO1xuICAgIH0pO1xuICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcyk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgUHVzaFdvcmtlcjtcbiJdfQ==