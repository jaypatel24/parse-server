'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.flatten = flatten;
exports.jobStatusHandler = jobStatusHandler;
exports.pushStatusHandler = pushStatusHandler;

var _cryptoUtils = require('./cryptoUtils');

var _logger = require('./logger');

var _rest = require('./rest');

var _rest2 = _interopRequireDefault(_rest);

var _Auth = require('./Auth');

var _Auth2 = _interopRequireDefault(_Auth);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const PUSH_STATUS_COLLECTION = '_PushStatus';
const JOB_STATUS_COLLECTION = '_JobStatus';

const incrementOp = function (object = {}, key, amount = 1) {
  if (!object[key]) {
    object[key] = { __op: 'Increment', amount: amount };
  } else {
    object[key].amount += amount;
  }
  return object[key];
};

function flatten(array) {
  var flattened = [];
  for (var i = 0; i < array.length; i++) {
    if (Array.isArray(array[i])) {
      flattened = flattened.concat(flatten(array[i]));
    } else {
      flattened.push(array[i]);
    }
  }
  return flattened;
}

function statusHandler(className, database) {
  let lastPromise = Promise.resolve();

  function create(object) {
    lastPromise = lastPromise.then(() => {
      return database.create(className, object).then(() => {
        return Promise.resolve(object);
      });
    });
    return lastPromise;
  }

  function update(where, object) {
    lastPromise = lastPromise.then(() => {
      return database.update(className, where, object);
    });
    return lastPromise;
  }

  return Object.freeze({
    create,
    update
  });
}

function restStatusHandler(className, config) {
  let lastPromise = Promise.resolve();
  const auth = _Auth2.default.master(config);
  function create(object) {
    lastPromise = lastPromise.then(() => {
      return _rest2.default.create(config, auth, className, object).then(({ response }) => {
        // merge the objects
        return Promise.resolve(Object.assign({}, object, response));
      });
    });
    return lastPromise;
  }

  function update(where, object) {
    // TODO: when we have updateWhere, use that for proper interfacing
    lastPromise = lastPromise.then(() => {
      return _rest2.default.update(config, auth, className, { objectId: where.objectId }, object).then(({ response }) => {
        // merge the objects
        return Promise.resolve(Object.assign({}, object, response));
      });
    });
    return lastPromise;
  }

  return Object.freeze({
    create,
    update
  });
}

function jobStatusHandler(config) {
  let jobStatus;
  const objectId = (0, _cryptoUtils.newObjectId)(config.objectIdSize);
  const database = config.database;
  const handler = statusHandler(JOB_STATUS_COLLECTION, database);
  const setRunning = function (jobName, params) {
    const now = new Date();
    jobStatus = {
      objectId,
      jobName,
      params,
      status: 'running',
      source: 'api',
      createdAt: now,
      // lockdown!
      ACL: {}
    };

    return handler.create(jobStatus);
  };

  const setMessage = function (message) {
    if (!message || typeof message !== 'string') {
      return Promise.resolve();
    }
    return handler.update({ objectId }, { message });
  };

  const setSucceeded = function (message) {
    return setFinalStatus('succeeded', message);
  };

  const setFailed = function (message) {
    return setFinalStatus('failed', message);
  };

  const setFinalStatus = function (status, message = undefined) {
    const finishedAt = new Date();
    const update = { status, finishedAt };
    if (message && typeof message === 'string') {
      update.message = message;
    }
    return handler.update({ objectId }, update);
  };

  return Object.freeze({
    setRunning,
    setSucceeded,
    setMessage,
    setFailed
  });
}

function pushStatusHandler(config, existingObjectId) {

  let pushStatus;
  const database = config.database;
  const handler = restStatusHandler(PUSH_STATUS_COLLECTION, config);
  let objectId = existingObjectId;
  const setInitial = function (body = {}, where, options = { source: 'rest' }) {
    const now = new Date();
    let pushTime = now.toISOString();
    let status = 'pending';
    if (body.hasOwnProperty('push_time')) {
      if (config.hasPushScheduledSupport) {
        pushTime = body.push_time;
        status = 'scheduled';
      } else {
        _logger.logger.warn('Trying to schedule a push while server is not configured.');
        _logger.logger.warn('Push will be sent immediately');
      }
    }

    const data = body.data || {};
    const payloadString = JSON.stringify(data);
    let pushHash;
    if (typeof data.alert === 'string') {
      pushHash = (0, _cryptoUtils.md5Hash)(data.alert);
    } else if (typeof data.alert === 'object') {
      pushHash = (0, _cryptoUtils.md5Hash)(JSON.stringify(data.alert));
    } else {
      pushHash = 'd41d8cd98f00b204e9800998ecf8427e';
    }
    const object = {
      pushTime,
      query: JSON.stringify(where),
      payload: payloadString,
      source: options.source,
      title: options.title,
      expiry: body.expiration_time,
      expiration_interval: body.expiration_interval,
      status: status,
      numSent: 0,
      pushHash,
      // lockdown!
      ACL: {}
    };
    return handler.create(object).then(result => {
      objectId = result.objectId;
      pushStatus = {
        objectId
      };
      return Promise.resolve(pushStatus);
    });
  };

  const setRunning = function (batches) {
    _logger.logger.verbose(`_PushStatus ${objectId}: sending push to installations with %d batches`, batches);
    return handler.update({
      status: "pending",
      objectId: objectId
    }, {
      status: "running",
      count: batches
    });
  };

  const trackSent = function (results, UTCOffset, cleanupInstallations = process.env.PARSE_SERVER_CLEANUP_INVALID_INSTALLATIONS) {
    const update = {
      numSent: 0,
      numFailed: 0
    };
    const devicesToRemove = [];
    if (Array.isArray(results)) {
      results = flatten(results);
      results.reduce((memo, result) => {
        // Cannot handle that
        if (!result || !result.device || !result.device.deviceType) {
          return memo;
        }
        const deviceType = result.device.deviceType;
        const key = result.transmitted ? `sentPerType.${deviceType}` : `failedPerType.${deviceType}`;
        memo[key] = incrementOp(memo, key);
        if (typeof UTCOffset !== 'undefined') {
          const offsetKey = result.transmitted ? `sentPerUTCOffset.${UTCOffset}` : `failedPerUTCOffset.${UTCOffset}`;
          memo[offsetKey] = incrementOp(memo, offsetKey);
        }
        if (result.transmitted) {
          memo.numSent++;
        } else {
          if (result && result.response && result.response.error && result.device && result.device.deviceToken) {
            const token = result.device.deviceToken;
            const error = result.response.error;
            // GCM errors
            if (error === 'NotRegistered' || error === 'InvalidRegistration') {
              devicesToRemove.push(token);
            }
            // APNS errors
            if (error === 'Unregistered' || error === 'BadDeviceToken') {
              devicesToRemove.push(token);
            }
          }
          memo.numFailed++;
        }
        return memo;
      }, update);
    }

    _logger.logger.verbose(`_PushStatus ${objectId}: sent push! %d success, %d failures`, update.numSent, update.numFailed);
    _logger.logger.verbose(`_PushStatus ${objectId}: needs cleanup`, { devicesToRemove });
    ['numSent', 'numFailed'].forEach(key => {
      if (update[key] > 0) {
        update[key] = {
          __op: 'Increment',
          amount: update[key]
        };
      } else {
        delete update[key];
      }
    });

    if (devicesToRemove.length > 0 && cleanupInstallations) {
      _logger.logger.info(`Removing device tokens on ${devicesToRemove.length} _Installations`);
      database.update('_Installation', { deviceToken: { '$in': devicesToRemove } }, { deviceToken: { "__op": "Delete" } }, {
        acl: undefined,
        many: true
      });
    }

    // indicate this batch is complete
    incrementOp(update, 'count', -1);

    return handler.update({ objectId }, update).then(res => {
      if (res && res.count === 0) {
        return this.complete();
      }
    });
  };

  const complete = function () {
    return handler.update({ objectId }, {
      status: 'succeeded',
      count: { __op: 'Delete' }
    });
  };

  const fail = function (err) {
    if (typeof err === 'string') {
      err = { message: err };
    }
    const update = {
      errorMessage: err,
      status: 'failed'
    };
    return handler.update({ objectId }, update);
  };

  const rval = {
    setInitial,
    setRunning,
    trackSent,
    complete,
    fail
  };

  // define objectId to be dynamic
  Object.defineProperty(rval, "objectId", {
    get: () => objectId
  });

  return Object.freeze(rval);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9TdGF0dXNIYW5kbGVyLmpzIl0sIm5hbWVzIjpbImZsYXR0ZW4iLCJqb2JTdGF0dXNIYW5kbGVyIiwicHVzaFN0YXR1c0hhbmRsZXIiLCJQVVNIX1NUQVRVU19DT0xMRUNUSU9OIiwiSk9CX1NUQVRVU19DT0xMRUNUSU9OIiwiaW5jcmVtZW50T3AiLCJvYmplY3QiLCJrZXkiLCJhbW91bnQiLCJfX29wIiwiYXJyYXkiLCJmbGF0dGVuZWQiLCJpIiwibGVuZ3RoIiwiQXJyYXkiLCJpc0FycmF5IiwiY29uY2F0IiwicHVzaCIsInN0YXR1c0hhbmRsZXIiLCJjbGFzc05hbWUiLCJkYXRhYmFzZSIsImxhc3RQcm9taXNlIiwiUHJvbWlzZSIsInJlc29sdmUiLCJjcmVhdGUiLCJ0aGVuIiwidXBkYXRlIiwid2hlcmUiLCJPYmplY3QiLCJmcmVlemUiLCJyZXN0U3RhdHVzSGFuZGxlciIsImNvbmZpZyIsImF1dGgiLCJtYXN0ZXIiLCJyZXNwb25zZSIsImFzc2lnbiIsIm9iamVjdElkIiwiam9iU3RhdHVzIiwib2JqZWN0SWRTaXplIiwiaGFuZGxlciIsInNldFJ1bm5pbmciLCJqb2JOYW1lIiwicGFyYW1zIiwibm93IiwiRGF0ZSIsInN0YXR1cyIsInNvdXJjZSIsImNyZWF0ZWRBdCIsIkFDTCIsInNldE1lc3NhZ2UiLCJtZXNzYWdlIiwic2V0U3VjY2VlZGVkIiwic2V0RmluYWxTdGF0dXMiLCJzZXRGYWlsZWQiLCJ1bmRlZmluZWQiLCJmaW5pc2hlZEF0IiwiZXhpc3RpbmdPYmplY3RJZCIsInB1c2hTdGF0dXMiLCJzZXRJbml0aWFsIiwiYm9keSIsIm9wdGlvbnMiLCJwdXNoVGltZSIsInRvSVNPU3RyaW5nIiwiaGFzT3duUHJvcGVydHkiLCJoYXNQdXNoU2NoZWR1bGVkU3VwcG9ydCIsInB1c2hfdGltZSIsIndhcm4iLCJkYXRhIiwicGF5bG9hZFN0cmluZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJwdXNoSGFzaCIsImFsZXJ0IiwicXVlcnkiLCJwYXlsb2FkIiwidGl0bGUiLCJleHBpcnkiLCJleHBpcmF0aW9uX3RpbWUiLCJleHBpcmF0aW9uX2ludGVydmFsIiwibnVtU2VudCIsInJlc3VsdCIsImJhdGNoZXMiLCJ2ZXJib3NlIiwiY291bnQiLCJ0cmFja1NlbnQiLCJyZXN1bHRzIiwiVVRDT2Zmc2V0IiwiY2xlYW51cEluc3RhbGxhdGlvbnMiLCJwcm9jZXNzIiwiZW52IiwiUEFSU0VfU0VSVkVSX0NMRUFOVVBfSU5WQUxJRF9JTlNUQUxMQVRJT05TIiwibnVtRmFpbGVkIiwiZGV2aWNlc1RvUmVtb3ZlIiwicmVkdWNlIiwibWVtbyIsImRldmljZSIsImRldmljZVR5cGUiLCJ0cmFuc21pdHRlZCIsIm9mZnNldEtleSIsImVycm9yIiwiZGV2aWNlVG9rZW4iLCJ0b2tlbiIsImZvckVhY2giLCJpbmZvIiwiYWNsIiwibWFueSIsInJlcyIsImNvbXBsZXRlIiwiZmFpbCIsImVyciIsImVycm9yTWVzc2FnZSIsInJ2YWwiLCJkZWZpbmVQcm9wZXJ0eSIsImdldCJdLCJtYXBwaW5ncyI6Ijs7Ozs7UUFpQmdCQSxPLEdBQUFBLE87UUFxRUFDLGdCLEdBQUFBLGdCO1FBcURBQyxpQixHQUFBQSxpQjs7QUEzSWhCOztBQUNBOztBQUNBOzs7O0FBQ0E7Ozs7OztBQUVBLE1BQU1DLHlCQUF5QixhQUEvQjtBQUNBLE1BQU1DLHdCQUF3QixZQUE5Qjs7QUFFQSxNQUFNQyxjQUFjLFVBQVNDLFNBQVMsRUFBbEIsRUFBc0JDLEdBQXRCLEVBQTJCQyxTQUFTLENBQXBDLEVBQXVDO0FBQ3pELE1BQUksQ0FBQ0YsT0FBT0MsR0FBUCxDQUFMLEVBQWtCO0FBQ2hCRCxXQUFPQyxHQUFQLElBQWMsRUFBQ0UsTUFBTSxXQUFQLEVBQW9CRCxRQUFRQSxNQUE1QixFQUFkO0FBQ0QsR0FGRCxNQUVPO0FBQ0xGLFdBQU9DLEdBQVAsRUFBWUMsTUFBWixJQUFzQkEsTUFBdEI7QUFDRDtBQUNELFNBQU9GLE9BQU9DLEdBQVAsQ0FBUDtBQUNELENBUEQ7O0FBU08sU0FBU1AsT0FB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V0EsUUFBTXFGLE9BQU87QUFDWHJELGNBRFc7QUFFWGxCLGNBRlc7QUFHWDRDLGFBSFc7QUFJWHVCLFlBSlc7QUFLWEM7QUFMVyxHQUFiOztBQVFBO0FBQ0FoRixTQUFPb0YsY0FBUCxDQUFzQkQsSUFBdEIsRUFBNEIsVUFBNUIsRUFBd0M7QUFDdENFLFNBQUssTUFBTTdFO0FBRDJCLEdBQXhDOztBQUlBLFNBQU9SLE9BQU9DLE1BQVAsQ0FBY2tGLElBQWQsQ0FBUDtBQUNEIiwiZmlsZSI6IlN0YXR1c0hhbmRsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBtZDVIYXNoLCBuZXdPYmplY3RJZCB9IGZyb20gJy4vY3J5cHRvVXRpbHMnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gICAgICAgICAgICAgICBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgcmVzdCAgICAgICAgICAgICAgICAgICAgIGZyb20gJy4vcmVzdCc7XG5pbXBvcnQgQXV0aCAgICAgICAgICAgICAgICAgICAgIGZyb20gJy4vQXV0aCc7XG5cbmNvbnN0IFBVU0hfU1RBVFVTX0NPTExFQ1RJT04gPSAnX1B1c2hTdGF0dXMnO1xuY29uc3QgSk9CX1NUQVRVU19DT0xMRUNUSU9OID0gJ19Kb2JTdGF0dXMnO1xuXG5jb25zdCBpbmNyZW1lbnRPcCA9IGZ1bmN0aW9uKG9iamVjdCA9IHt9LCBrZXksIGFtb3VudCA9IDEpIHtcbiAgaWYgKCFvYmplY3Rba2V5XSkge1xuICAgIG9iamVjdFtrZXldID0ge19fb3A6ICdJbmNyZW1lbnQnLCBhbW91bnQ6IGFtb3VudH1cbiAgfSBlbHNlIHtcbiAgICBvYmplY3Rba2V5XS5hbW91bnQgKz0gYW1vdW50O1xuICB9XG4gIHJldHVybiBvYmplY3Rba2V5XTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGZsYXR0ZW4oYXJyYXkpIHtcbiAgdmFyIGZsYXR0ZW5lZCA9IFtdO1xuICBmb3IodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyBpKyspIHtcbiAgICBpZihBcnJheS5pc0FycmF5KGFycmF5W2ldKSkge1xuICAgICAgZmxhdHRlbmVkID0gZmxhdHRlbmVkLmNvbmNhdChmbGF0dGVuKGFycmF5W2ldKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGZsYXR0ZW5lZC5wdXNoKGFycmF5W2ldKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGZsYXR0ZW5lZDtcbn1cblxuZnVuY3Rpb24gc3RhdHVzSGFuZGxlcihjbGFzc05hbWUsIGRhdGFiYXNlKSB7XG4gIGxldCBsYXN0UHJvbWlzZSA9IFByb21pc2UucmVzb2x2ZSgpO1xuXG4gIGZ1bmN0aW9uIGNyZWF0ZShvYmplY3QpIHtcbiAgICBsYXN0UHJvbWlzZSA9IGxhc3RQcm9taXNlLnRoZW4oKCkgPT4ge1xuICAgICAgcmV0dXJuIGRhdGFiYXNlLmNyZWF0ZShjbGFzc05hbWUsIG9iamVjdCkudGhlbigoKSA9PiB7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUob2JqZWN0KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJldHVybiBsYXN0UHJvbWlzZTtcbiAgfVxuXG4gIGZ1bmN0aW9uIHVwZGF0ZSh3aGVyZSwgb2JqZWN0KSB7XG4gICAgbGFzdFByb21pc2UgPSBsYXN0UHJvbWlzZS50aGVuKCgpID0+IHtcbiAgICAgIHJldHVybiBkYXRhYmFzZS51cGRhdGUoY2xhc3NOYW1lLCB3aGVyZSwgb2JqZWN0KTtcbiAgICB9KTtcbiAgICByZXR1cm4gbGFzdFByb21pc2U7XG4gIH1cblxuICByZXR1cm4gT2JqZWN0LmZyZWV6ZSh7XG4gICAgY3JlYXRlLFxuICAgIHVwZGF0ZVxuICB9KVxufVxuXG5mdW5jdGlvbiByZXN0U3RhdHVzSGFuZGxlcihjbGFzc05hbWUsIGNvbmZpZykge1xuICBsZXQgbGFzdFByb21pc2UgPSBQcm9taXNlLnJlc29sdmUoKTtcbiAgY29uc3QgYXV0aCA9IEF1dGgubWFzdGVyKGNvbmZpZyk7XG4gIGZ1bmN0aW9uIGNyZWF0ZShvYmplY3QpIHtcbiAgICBsYXN0UHJvbWlzZSA9IGxhc3RQcm9taXNlLnRoZW4oKCkgPT4ge1xuICAgICAgcmV0dXJuIHJlc3QuY3JlYXRlKGNvbmZpZywgYXV0aCwgY2xhc3NOYW1lLCBvYmplY3QpXG4gICAgICAgIC50aGVuKCh7IHJlc3BvbnNlIH0pID0+IHtcbiAgICAgICAgICAvLyBtZXJnZSB0aGUgb2JqZWN0c1xuICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoT2JqZWN0LmFzc2lnbih7fSwgb2JqZWN0LCByZXNwb25zZSkpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gbGFzdFByb21pc2U7XG4gIH1cblxuICBmdW5jdGlvbiB1cGRhdGUod2hlcmUsIG9iamVjdCkge1xuICAgIC8vIFRPRE86IHdoZW4gd2UgaGF2ZSB1cGRhdGVXaGVyZSwgdXNlIHRoYXQgZm9yIHByb3BlciBpbnRlcmZhY2luZ1xuICAgIGxhc3RQcm9taXNlID0gbGFzdFByb21pc2UudGhlbigoKSA9PiB7XG4gICAgICByZXR1cm4gcmVzdC51cGRhdGUoY29uZmlnLCBhdXRoLCBjbGFzc05hbWUsIHsgb2JqZWN0SWQ6IHdoZXJlLm9iamVjdElkIH0sIG9iamVjdClcbiAgICAgICAgLnRoZW4oKHsgcmVzcG9uc2UgfSkgPT4ge1xuICAgICAgICAgIC8vIG1lcmdlIHRoZSBvYmplY3RzXG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShPYmplY3QuYXNzaWduKHt9LCBvYmplY3QsIHJlc3BvbnNlKSk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICAgIHJldHVybiBsYXN0UHJvbWlzZTtcbiAgfVxuXG4gIHJldHVybiBPYmplY3QuZnJlZXplKHtcbiAgICBjcmVhdGUsXG4gICAgdXBkYXRlXG4gIH0pXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBqb2JTdGF0dXNIYW5kbGVyKGNvbmZpZykge1xuICBsZXQgam9iU3RhdHVzO1xuICBjb25zdCBvYmplY3RJZCA9IG5ld09iamVjdElkKGNvbmZpZy5vYmplY3RJZFNpemUpO1xuICBjb25zdCBkYXRhYmFzZSA9IGNvbmZpZy5kYXRhYmFzZTtcbiAgY29uc3QgaGFuZGxlciA9IHN0YXR1c0hhbmRsZXIoSk9CX1NUQVRVU19DT0xMRUNUSU9OLCBkYXRhYmFzZSk7XG4gIGNvbnN0IHNldFJ1bm5pbmcgPSBmdW5jdGlvbihqb2JOYW1lLCBwYXJhbXMpIHtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGpvYlN0YXR1cyA9IHtcbiAgICAgIG9iamVjdElkLFxuICAgICAgam9iTmFtZSxcbiAgICAgIHBhcmFtcyxcbiAgICAgIHN0YXR1czogJ3J1bm5pbmcnLFxuICAgICAgc291cmNlOiAnYXBpJyxcbiAgICAgIGNyZWF0ZWRBdDogbm93LFxuICAgICAgLy8gbG9ja2Rvd24hXG4gICAgICBBQ0w6IHt9XG4gICAgfVxuXG4gICAgcmV0dXJuIGhhbmRsZXIuY3JlYXRlKGpvYlN0YXR1cyk7XG4gIH1cblxuICBjb25zdCBzZXRNZXNzYWdlID0gZnVuY3Rpb24obWVzc2FnZSkge1xuICAgIGlmICghbWVzc2FnZSB8fCB0eXBlb2YgbWVzc2FnZSAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTtcbiAgICB9XG4gICAgcmV0dXJuIGhhbmRsZXIudXBkYXRlKHsgb2JqZWN0SWQgfSwgeyBtZXNzYWdlIH0pO1xuICB9XG5cbiAgY29uc3Qgc2V0U3VjY2VlZGVkID0gZnVuY3Rpb24obWVzc2FnZSkge1xuICAgIHJldHVybiBzZXRGaW5hbFN0YXR1cygnc3VjY2VlZGVkJywgbWVzc2FnZSk7XG4gIH1cblxuICBjb25zdCBzZXRGYWlsZWQgPSBmdW5jdGlvbihtZXNzYWdlKSB7XG4gICAgcmV0dXJuIHNldEZpbmFsU3RhdHVzKCdmYWlsZWQnLCBtZXNzYWdlKTtcbiAgfVxuXG4gIGNvbnN0IHNldEZpbmFsU3RhdHVzID0gZnVuY3Rpb24oc3RhdHVzLCBtZXNzYWdlID0gdW5kZWZpbmVkKSB7XG4gICAgY29uc3QgZmluaXNoZWRBdCA9IG5ldyBEYXRlKCk7XG4gICAgY29uc3QgdXBkYXRlID0geyBzdGF0dXMsIGZpbmlzaGVkQXQgfTtcbiAgICBpZiAobWVzc2FnZSAmJiB0eXBlb2YgbWVzc2FnZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIHVwZGF0ZS5tZXNzYWdlID0gbWVzc2FnZTtcbiAgICB9XG4gICAgcmV0dXJuIGhhbmRsZXIudXBkYXRlKHsgb2JqZWN0SWQgfSwgdXBkYXRlKTtcbiAgfVxuXG4gIHJldHVybiBPYmplY3QuZnJlZXplKHtcbiAgICBzZXRSdW5uaW5nLFxuICAgIHNldFN1Y2NlZWRlZCxcbiAgICBzZXRNZXNzYWdlLFxuICAgIHNldEZhaWxlZFxuICB9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHB1c2hTdGF0dXNIYW5kbGVyKGNvbmZpZywgZXhpc3RpbmdPYmplY3RJZCkge1xuXG4gIGxldCBwdXNoU3RhdHVzO1xuICBjb25zdCBkYXRhYmFzZSA9IGNvbmZpZy5kYXRhYmFzZTtcbiAgY29uc3QgaGFuZGxlciA9IHJlc3RTdGF0dXNIYW5kbGVyKFBVU0hfU1RBVFVTX0NPTExFQ1RJT04sIGNvbmZpZyk7XG4gIGxldCBvYmplY3RJZCA9IGV4aXN0aW5nT2JqZWN0SWQ7XG4gIGNvbnN0IHNldEluaXRpYWwgPSBmdW5jdGlvbihib2R5ID0ge30sIHdoZXJlLCBvcHRpb25zID0ge3NvdXJjZTogJ3Jlc3QnfSkge1xuICAgIGNvbnN0IG5vdyA9IG5ldyBEYXRlKCk7XG4gICAgbGV0IHB1c2hUaW1lID0gbm93LnRvSVNPU3RyaW5nKCk7XG4gICAgbGV0IHN0YXR1cyA9ICdwZW5kaW5nJztcbiAgICBpZiAoYm9keS5oYXNPd25Qcm9wZXJ0eSgncHVzaF90aW1lJykpIHtcbiAgICAgIGlmIChjb25maWcuaGFzUHVzaFNjaGVkdWxlZFN1cHBvcnQpIHtcbiAgICAgICAgcHVzaFRpbWUgPSBib2R5LnB1c2hfdGltZTtcbiAgICAgICAgc3RhdHVzID0gJ3NjaGVkdWxlZCc7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIud2FybignVHJ5aW5nIHRvIHNjaGVkdWxlIGEgcHVzaCB3aGlsZSBzZXJ2ZXIgaXMgbm90IGNvbmZpZ3VyZWQuJyk7XG4gICAgICAgIGxvZ2dlci53YXJuKCdQdXNoIHdpbGwgYmUgc2VudCBpbW1lZGlhdGVseScpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGRhdGEgPSAgYm9keS5kYXRhIHx8IHt9O1xuICAgIGNvbnN0IHBheWxvYWRTdHJpbmcgPSBKU09OLnN0cmluZ2lmeShkYXRhKTtcbiAgICBsZXQgcHVzaEhhc2g7XG4gICAgaWYgKHR5cGVvZiBkYXRhLmFsZXJ0ID09PSAnc3RyaW5nJykge1xuICAgICAgcHVzaEhhc2ggPSBtZDVIYXNoKGRhdGEuYWxlcnQpO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGRhdGEuYWxlcnQgPT09ICdvYmplY3QnKSB7XG4gICAgICBwdXNoSGFzaCA9IG1kNUhhc2goSlNPTi5zdHJpbmdpZnkoZGF0YS5hbGVydCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBwdXNoSGFzaCA9ICdkNDFkOGNkOThmMDBiMjA0ZTk4MDA5OThlY2Y4NDI3ZSc7XG4gICAgfVxuICAgIGNvbnN0IG9iamVjdCA9IHtcbiAgICAgIHB1c2hUaW1lLFxuICAgICAgcXVlcnk6IEpTT04uc3RyaW5naWZ5KHdoZXJlKSxcbiAgICAgIHBheWxvYWQ6IHBheWxvYWRTdHJpbmcsXG4gICAgICBzb3VyY2U6IG9wdGlvbnMuc291cmNlLFxuICAgICAgdGl0bGU6IG9wdGlvbnMudGl0bGUsXG4gICAgICBleHBpcnk6IGJvZHkuZXhwaXJhdGlvbl90aW1lLFxuICAgICAgZXhwaXJhdGlvbl9pbnRlcnZhbDogYm9keS5leHBpcmF0aW9uX2ludGVydmFsLFxuICAgICAgc3RhdHVzOiBzdGF0dXMsXG4gICAgICBudW1TZW50OiAwLFxuICAgICAgcHVzaEhhc2gsXG4gICAgICAvLyBsb2NrZG93biFcbiAgICAgIEFDTDoge31cbiAgICB9XG4gICAgcmV0dXJuIGhhbmRsZXIuY3JlYXRlKG9iamVjdCkudGhlbigocmVzdWx0KSA9PiB7XG4gICAgICBvYmplY3RJZCA9IHJlc3VsdC5vYmplY3RJZDtcbiAgICAgIHB1c2hTdGF0dXMgPSB7XG4gICAgICAgIG9iamVjdElkXG4gICAgICB9O1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShwdXNoU3RhdHVzKTtcbiAgICB9KTtcbiAgfVxuXG4gIGNvbnN0IHNldFJ1bm5pbmcgPSBmdW5jdGlvbihiYXRjaGVzKSB7XG4gICAgbG9nZ2VyLnZlcmJvc2UoYF9QdXNoU3RhdHVzICR7b2JqZWN0SWR9OiBzZW5kaW5nIHB1c2ggdG8gaW5zdGFsbGF0aW9ucyB3aXRoICVkIGJhdGNoZXNgLCBiYXRjaGVzKTtcbiAgICByZXR1cm4gaGFuZGxlci51cGRhdGUoXG4gICAgICB7XG4gICAgICAgIHN0YXR1czpcInBlbmRpbmdcIixcbiAgICAgICAgb2JqZWN0SWQ6IG9iamVjdElkXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBzdGF0dXM6IFwicnVubmluZ1wiLFxuICAgICAgICBjb3VudDogYmF0Y2hlc1xuICAgICAgfVxuICAgICk7XG4gIH1cblxuICBjb25zdCB0cmFja1NlbnQgPSBmdW5jdGlvbihyZXN1bHRzLCBVVENPZmZzZXQsIGNsZWFudXBJbnN0YWxsYXRpb25zID0gcHJvY2Vzcy5lbnYuUEFSU0VfU0VSVkVSX0NMRUFOVVBfSU5WQUxJRF9JTlNUQUxMQVRJT05TKSB7XG4gICAgY29uc3QgdXBkYXRlID0ge1xuICAgICAgbnVtU2VudDogMCxcbiAgICAgIG51bUZhaWxlZDogMFxuICAgIH07XG4gICAgY29uc3QgZGV2aWNlc1RvUmVtb3ZlID0gW107XG4gICAgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0cykpIHtcbiAgICAgIHJlc3VsdHMgPSBmbGF0dGVuKHJlc3VsdHMpO1xuICAgICAgcmVzdWx0cy5yZWR1Y2UoKG1lbW8sIHJlc3VsdCkgPT4ge1xuICAgICAgICAvLyBDYW5ub3QgaGFuZGxlIHRoYXRcbiAgICAgICAgaWYgKCFyZXN1bHQgfHwgIXJlc3VsdC5kZXZpY2UgfHwgIXJlc3VsdC5kZXZpY2UuZGV2aWNlVHlwZSkge1xuICAgICAgICAgIHJldHVybiBtZW1vO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGRldmljZVR5cGUgPSByZXN1bHQuZGV2aWNlLmRldmljZVR5cGU7XG4gICAgICAgIGNvbnN0IGtleSA9IHJlc3VsdC50cmFuc21pdHRlZCA/IGBzZW50UGVyVHlwZS4ke2RldmljZVR5cGV9YCA6IGBmYWlsZWRQZXJUeXBlLiR7ZGV2aWNlVHlwZX1gO1xuICAgICAgICBtZW1vW2tleV0gPSBpbmNyZW1lbnRPcChtZW1vLCBrZXkpO1xuICAgICAgICBpZiAodHlwZW9mIFVUQ09mZnNldCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgICBjb25zdCBvZmZzZXRLZXkgPSByZXN1bHQudHJhbnNtaXR0ZWQgPyBgc2VudFBlclVUQ09mZnNldC4ke1VUQ09mZnNldH1gIDogYGZhaWxlZFBlclVUQ09mZnNldC4ke1VUQ09mZnNldH1gO1xuICAgICAgICAgIG1lbW9bb2Zmc2V0S2V5XSA9IGluY3JlbWVudE9wKG1lbW8sIG9mZnNldEtleSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHJlc3VsdC50cmFuc21pdHRlZCkge1xuICAgICAgICAgIG1lbW8ubnVtU2VudCsrO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChyZXN1bHQgJiYgcmVzdWx0LnJlc3BvbnNlICYmIHJlc3VsdC5yZXNwb25zZS5lcnJvciAmJiByZXN1bHQuZGV2aWNlICYmIHJlc3VsdC5kZXZpY2UuZGV2aWNlVG9rZW4pIHtcbiAgICAgICAgICAgIGNvbnN0IHRva2VuID0gcmVzdWx0LmRldmljZS5kZXZpY2VUb2tlbjtcbiAgICAgICAgICAgIGNvbnN0IGVycm9yID0gcmVzdWx0LnJlc3BvbnNlLmVycm9yO1xuICAgICAgICAgICAgLy8gR0NNIGVycm9yc1xuICAgICAgICAgICAgaWYgKGVycm9yID09PSAnTm90UmVnaXN0ZXJlZCcgfHwgZXJyb3IgPT09ICdJbnZhbGlkUmVnaXN0cmF0aW9uJykge1xuICAgICAgICAgICAgICBkZXZpY2VzVG9SZW1vdmUucHVzaCh0b2tlbik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBBUE5TIGVycm9yc1xuICAgICAgICAgICAgaWYgKGVycm9yID09PSAnVW5yZWdpc3RlcmVkJyB8fCBlcnJvciA9PT0gJ0JhZERldmljZVRva2VuJykge1xuICAgICAgICAgICAgICBkZXZpY2VzVG9SZW1vdmUucHVzaCh0b2tlbik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIG1lbW8ubnVtRmFpbGVkKys7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG1lbW87XG4gICAgICB9LCB1cGRhdGUpO1xuICAgIH1cblxuICAgIGxvZ2dlci52ZXJib3NlKGBfUHVzaFN0YXR1cyAke29iamVjdElkfTogc2VudCBwdXNoISAlZCBzdWNjZXNzLCAlZCBmYWlsdXJlc2AsIHVwZGF0ZS5udW1TZW50LCB1cGRhdGUubnVtRmFpbGVkKTtcbiAgICBsb2dnZXIudmVyYm9zZShgX1B1c2hTdGF0dXMgJHtvYmplY3RJZH06IG5lZWRzIGNsZWFudXBgLCB7IGRldmljZXNUb1JlbW92ZSB9KTtcbiAgICBbJ251bVNlbnQnLCAnbnVtRmFpbGVkJ10uZm9yRWFjaCgoa2V5KSA9PiB7XG4gICAgICBpZiAodXBkYXRlW2tleV0gPiAwKSB7XG4gICAgICAgIHVwZGF0ZVtrZXldID0ge1xuICAgICAgICAgIF9fb3A6ICdJbmNyZW1lbnQnLFxuICAgICAgICAgIGFtb3VudDogdXBkYXRlW2tleV1cbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRlbGV0ZSB1cGRhdGVba2V5XTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmIChkZXZpY2VzVG9SZW1vdmUubGVuZ3RoID4gMCAmJiBjbGVhbnVwSW5zdGFsbGF0aW9ucykge1xuICAgICAgbG9nZ2VyLmluZm8oYFJlbW92aW5nIGRldmljZSB0b2tlbnMgb24gJHtkZXZpY2VzVG9SZW1vdmUubGVuZ3RofSBfSW5zdGFsbGF0aW9uc2ApO1xuICAgICAgZGF0YWJhc2UudXBkYXRlKCdfSW5zdGFsbGF0aW9uJywgeyBkZXZpY2VUb2tlbjogeyAnJGluJzogZGV2aWNlc1RvUmVtb3ZlIH19LCB7IGRldmljZVRva2VuOiB7XCJfX29wXCI6IFwiRGVsZXRlXCJ9IH0sIHtcbiAgICAgICAgYWNsOiB1bmRlZmluZWQsXG4gICAgICAgIG1hbnk6IHRydWVcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIGluZGljYXRlIHRoaXMgYmF0Y2ggaXMgY29tcGxldGVcbiAgICBpbmNyZW1lbnRPcCh1cGRhdGUsICdjb3VudCcsIC0xKTtcblxuICAgIHJldHVybiBoYW5kbGVyLnVwZGF0ZSh7IG9iamVjdElkIH0sIHVwZGF0ZSkudGhlbigocmVzKSA9PiB7XG4gICAgICBpZiAocmVzICYmIHJlcy5jb3VudCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gdGhpcy5jb21wbGV0ZSgpO1xuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBjb25zdCBjb21wbGV0ZSA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiBoYW5kbGVyLnVwZGF0ZSh7IG9iamVjdElkIH0sIHtcbiAgICAgIHN0YXR1czogJ3N1Y2NlZWRlZCcsXG4gICAgICBjb3VudDoge19fb3A6ICdEZWxldGUnfVxuICAgIH0pO1xuICB9XG5cbiAgY29uc3QgZmFpbCA9IGZ1bmN0aW9uKGVycikge1xuICAgIGlmICh0eXBlb2YgZXJyID09PSAnc3RyaW5nJykge1xuICAgICAgZXJyID0geyBtZXNzYWdlOiBlcnIgfTtcbiAgICB9XG4gICAgY29uc3QgdXBkYXRlID0ge1xuICAgICAgZXJyb3JNZXNzYWdlOiBlcnIsXG4gICAgICBzdGF0dXM6ICdmYWlsZWQnXG4gICAgfVxuICAgIHJldHVybiBoYW5kbGVyLnVwZGF0ZSh7IG9iamVjdElkIH0sIHVwZGF0ZSk7XG4gIH1cblxuICBjb25zdCBydmFsID0ge1xuICAgIHNldEluaXRpYWwsXG4gICAgc2V0UnVubmluZyxcbiAgICB0cmFja1NlbnQsXG4gICAgY29tcGxldGUsXG4gICAgZmFpbFxuICB9O1xuXG4gIC8vIGRlZmluZSBvYmplY3RJZCB0byBiZSBkeW5hbWljXG4gIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShydmFsLCBcIm9iamVjdElkXCIsIHtcbiAgICBnZXQ6ICgpID0+IG9iamVjdElkXG4gIH0pO1xuXG4gIHJldHVybiBPYmplY3QuZnJlZXplKHJ2YWwpO1xufVxuIl19