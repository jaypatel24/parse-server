'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Client = undefined;

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const dafaultFields = ['className', 'objectId', 'updatedAt', 'createdAt', 'ACL'];

class Client {

  constructor(id, parseWebSocket, hasMasterKey) {
    this.id = id;
    this.parseWebSocket = parseWebSocket;
    this.hasMasterKey = hasMasterKey;
    this.roles = [];
    this.subscriptionInfos = new Map();
    this.pushConnect = this._pushEvent('connected');
    this.pushSubscribe = this._pushEvent('subscribed');
    this.pushUnsubscribe = this._pushEvent('unsubscribed');
    this.pushCreate = this._pushEvent('create');
    this.pushEnter = this._pushEvent('enter');
    this.pushUpdate = this._pushEvent('update');
    this.pushDelete = this._pushEvent('delete');
    this.pushLeave = this._pushEvent('leave');
  }

  static pushResponse(parseWebSocket, message) {
    _logger2.default.verbose('Push Response : %j', message);
    parseWebSocket.send(message);
  }

  static pushError(parseWebSocket, code, error, reconnect = true) {
    Client.pushResponse(parseWebSocket, JSON.stringify({
      'op': 'error',
      'error': error,
      'code': code,
      'reconnect': reconnect
    }));
  }

  addSubscriptionInfo(requestId, subscriptionInfo) {
    this.subscriptionInfos.set(requestId, subscriptionInfo);
  }

  getSubscriptionInfo(requestId) {
    return this.subscriptionInfos.get(requestId);
  }

  deleteSubscriptionInfo(requestId) {
    return this.subscriptionInfos.delete(requestId);
  }

  _pushEvent(type) {
    return function (subscriptionId, parseObjectJSON) {
      const response = {
        'op': type,
        'clientId': this.id
      };
      if (typeof subscriptionId !== 'undefined') {
        response['requestId'] = subscriptionId;
      }
      if (typeof parseObjectJSON !== 'undefined') {
        let fields;
        if (this.subscriptionInfos.has(subscriptionId)) {
          fields = this.subscriptionInfos.get(subscriptionId).fields;
        }
        response['object'] = this._toJSONWithFields(parseObjectJSON, fields);
      }
      Client.pushResponse(this.parseWebSocket, JSON.stringify(response));
    };
  }

  _toJSONWithFields(parseObjectJSON, fields) {
    if (!fields) {
      return parseObjectJSON;
    }
    const limitedParseObject = {};
    for (const field of dafaultFields) {
      limitedParseObject[field] = parseObjectJSON[field];
    }
    for (const field of fields) {
      if (field in parseObjectJSON) {
        limitedParseObject[field] = parseObjectJSON[field];
      }
    }
    return limitedParseObject;
  }
}

exports.Client = Client;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9MaXZlUXVlcnkvQ2xpZW50LmpzIl0sIm5hbWVzIjpbImRhZmF1bHRGaWVsZHMiLCJDbGllbnQiLCJjb25zdHJ1Y3RvciIsImlkIiwicGFyc2VXZWJTb2NrZXQiLCJoYXNNYXN0ZXJLZXkiLCJyb2xlcyIsInN1YnNjcmlwdGlvbkluZm9zIiwiTWFwIiwicHVzaENvbm5lY3QiLCJfcHVzaEV2ZW50IiwicHVzaFN1YnNjcmliZSIsInB1c2hVbnN1YnNjcmliZSIsInB1c2hDcmVhdGUiLCJwdXNoRW50ZXIiLCJwdXNoVXBkYXRlIiwicHVzaERlbGV0ZSIsInB1c2hMZWF2ZSIsInB1c2hSZXNwb25zZSIsIm1lc3NhZ2UiLCJ2ZXJib3NlIiwic2VuZCIsInB1c2hFcnJvciIsImNvZGUiLCJlcnJvciIsInJlY29ubmVjdCIsIkpTT04iLCJzdHJpbmdpZnkiLCJhZGRTdWJzY3JpcHRpb25JbmZvIiwicmVxdWVzdElkIiwic3Vic2NyaXB0aW9uSW5mbyIsInNldCIsImdldFN1YnNjcmlwdGlvbkluZm8iLCJnZXQiLCJkZWxldGVTdWJzY3JpcHRpb25JbmZvIiwiZGVsZXRlIiwidHlwZSIsInN1YnNjcmlwdGlvbklkIiwicGFyc2VPYmplY3RKU09OIiwicmVzcG9uc2UiLCJmaWVsZHMiLCJoYXMiLCJfdG9KU09OV2l0aEZpZWxkcyIsImxpbWl0ZWRQYXJzZU9iamVjdCIsImZpZWxkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7Ozs7OztBQUtBLE1BQU1BLGdCQUFnQixDQUFDLFdBQUQsRUFBYyxVQUFkLEVBQTBCLFdBQTFCLEVBQXVDLFdBQXZDLEVBQW9ELEtBQXBELENBQXRCOztBQUVBLE1BQU1DLE1BQU4sQ0FBYTs7QUFnQlhDLGNBQVlDLEVBQVosRUFBd0JDLGNBQXhCLEVBQTZDQyxZQUE3QyxFQUFvRTtBQUNsRSxTQUFLRixFQUFMLEdBQVVBLEVBQVY7QUFDQSxTQUFLQyxjQUFMLEdBQXNCQSxjQUF0QjtBQUNBLFNBQUtDLFlBQUwsR0FBb0JB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U0FBSyxNQUFNQyxLQUFYLElBQW9CNUMsYUFBcEIsRUFBbUM7QUFDakMyQyx5QkFBbUJDLEtBQW5CLElBQTRCTixnQkFBZ0JNLEtBQWhCLENBQTVCO0FBQ0Q7QUFDRCxTQUFLLE1BQU1BLEtBQVgsSUFBb0JKLE1BQXBCLEVBQTRCO0FBQzFCLFVBQUlJLFNBQVNOLGVBQWIsRUFBOEI7QUFDNUJLLDJCQUFtQkMsS0FBbkIsSUFBNEJOLGdCQUFnQk0sS0FBaEIsQ0FBNUI7QUFDRDtBQUNGO0FBQ0QsV0FBT0Qsa0JBQVA7QUFDRDtBQTVGVTs7UUFnR1gxQyxNLEdBQUFBLE0iLCJmaWxlIjoiQ2xpZW50LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZ2dlciBmcm9tICcuLi9sb2dnZXInO1xuXG5pbXBvcnQgdHlwZSB7IEZsYXR0ZW5lZE9iamVjdERhdGEgfSBmcm9tICcuL1N1YnNjcmlwdGlvbic7XG5leHBvcnQgdHlwZSBNZXNzYWdlID0geyBbYXR0cjogc3RyaW5nXTogYW55IH07XG5cbmNvbnN0IGRhZmF1bHRGaWVsZHMgPSBbJ2NsYXNzTmFtZScsICdvYmplY3RJZCcsICd1cGRhdGVkQXQnLCAnY3JlYXRlZEF0JywgJ0FDTCddO1xuXG5jbGFzcyBDbGllbnQge1xuICBpZDogbnVtYmVyO1xuICBwYXJzZVdlYlNvY2tldDogYW55O1xuICBoYXNNYXN0ZXJLZXk6IGJvb2xlYW47XG4gIHVzZXJJZDogc3RyaW5nO1xuICByb2xlczogQXJyYXk8c3RyaW5nPjtcbiAgc3Vic2NyaXB0aW9uSW5mb3M6IE9iamVjdDtcbiAgcHVzaENvbm5lY3Q6IEZ1bmN0aW9uO1xuICBwdXNoU3Vic2NyaWJlOiBGdW5jdGlvbjtcbiAgcHVzaFVuc3Vic2NyaWJlOiBGdW5jdGlvbjtcbiAgcHVzaENyZWF0ZTogRnVuY3Rpb247XG4gIHB1c2hFbnRlcjogRnVuY3Rpb247XG4gIHB1c2hVcGRhdGU6IEZ1bmN0aW9uO1xuICBwdXNoRGVsZXRlOiBGdW5jdGlvbjtcbiAgcHVzaExlYXZlOiBGdW5jdGlvbjtcblxuICBjb25zdHJ1Y3RvcihpZDogbnVtYmVyLCBwYXJzZVdlYlNvY2tldDogYW55LCBoYXNNYXN0ZXJLZXk6IGJvb2xlYW4pIHtcbiAgICB0aGlzLmlkID0gaWQ7XG4gICAgdGhpcy5wYXJzZVdlYlNvY2tldCA9IHBhcnNlV2ViU29ja2V0O1xuICAgIHRoaXMuaGFzTWFzdGVyS2V5ID0gaGFzTWFzdGVyS2V5O1xuICAgIHRoaXMucm9sZXMgPSBbXTtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbkluZm9zID0gbmV3IE1hcCgpO1xuICAgIHRoaXMucHVzaENvbm5lY3QgPSB0aGlzLl9wdXNoRXZlbnQoJ2Nvbm5lY3RlZCcpO1xuICAgIHRoaXMucHVzaFN1YnNjcmliZSA9IHRoaXMuX3B1c2hFdmVudCgnc3Vic2NyaWJlZCcpO1xuICAgIHRoaXMucHVzaFVuc3Vic2NyaWJlID0gdGhpcy5fcHVzaEV2ZW50KCd1bnN1YnNjcmliZWQnKTtcbiAgICB0aGlzLnB1c2hDcmVhdGUgPSB0aGlzLl9wdXNoRXZlbnQoJ2NyZWF0ZScpO1xuICAgIHRoaXMucHVzaEVudGVyID0gdGhpcy5fcHVzaEV2ZW50KCdlbnRlcicpO1xuICAgIHRoaXMucHVzaFVwZGF0ZSA9IHRoaXMuX3B1c2hFdmVudCgndXBkYXRlJyk7XG4gICAgdGhpcy5wdXNoRGVsZXRlID0gdGhpcy5fcHVzaEV2ZW50KCdkZWxldGUnKTtcbiAgICB0aGlzLnB1c2hMZWF2ZSA9IHRoaXMuX3B1c2hFdmVudCgnbGVhdmUnKTtcbiAgfVxuXG4gIHN0YXRpYyBwdXNoUmVzcG9uc2UocGFyc2VXZWJTb2NrZXQ6IGFueSwgbWVzc2FnZTogTWVzc2FnZSk6IHZvaWQge1xuICAgIGxvZ2dlci52ZXJib3NlKCdQdXNoIFJlc3BvbnNlIDogJWonLCBtZXNzYWdlKTtcbiAgICBwYXJzZVdlYlNvY2tldC5zZW5kKG1lc3NhZ2UpO1xuICB9XG5cbiAgc3RhdGljIHB1c2hFcnJvcihwYXJzZVdlYlNvY2tldDogYW55LCBjb2RlOiBudW1iZXIsIGVycm9yOiBzdHJpbmcsIHJlY29ubmVjdDogYm9vbGVhbiA9IHRydWUpOiB2b2lkIHtcbiAgICBDbGllbnQucHVzaFJlc3BvbnNlKHBhcnNlV2ViU29ja2V0LCBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAnb3AnOiAnZXJyb3InLFxuICAgICAgJ2Vycm9yJzogZXJyb3IsXG4gICAgICAnY29kZSc6IGNvZGUsXG4gICAgICAncmVjb25uZWN0JzogcmVjb25uZWN0XG4gICAgfSkpO1xuICB9XG5cbiAgYWRkU3Vic2NyaXB0aW9uSW5mbyhyZXF1ZXN0SWQ6IG51bWJlciwgc3Vic2NyaXB0aW9uSW5mbzogYW55KTogdm9pZCB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb25JbmZvcy5zZXQocmVxdWVzdElkLCBzdWJzY3JpcHRpb25JbmZvKTtcbiAgfVxuXG4gIGdldFN1YnNjcmlwdGlvbkluZm8ocmVxdWVzdElkOiBudW1iZXIpOiBhbnkge1xuICAgIHJldHVybiB0aGlzLnN1YnNjcmlwdGlvbkluZm9zLmdldChyZXF1ZXN0SWQpO1xuICB9XG5cbiAgZGVsZXRlU3Vic2NyaXB0aW9uSW5mbyhyZXF1ZXN0SWQ6IG51bWJlcik6IHZvaWQge1xuICAgIHJldHVybiB0aGlzLnN1YnNjcmlwdGlvbkluZm9zLmRlbGV0ZShyZXF1ZXN0SWQpO1xuICB9XG5cbiAgX3B1c2hFdmVudCh0eXBlOiBzdHJpbmcpOiBGdW5jdGlvbiB7XG4gICAgcmV0dXJuIGZ1bmN0aW9uKHN1YnNjcmlwdGlvbklkOiBudW1iZXIsIHBhcnNlT2JqZWN0SlNPTjogYW55KTogdm9pZCB7XG4gICAgICBjb25zdCByZXNwb25zZTogTWVzc2FnZSA9IHtcbiAgICAgICAgJ29wJyA6IHR5cGUsXG4gICAgICAgICdjbGllbnRJZCcgOiB0aGlzLmlkXG4gICAgICB9O1xuICAgICAgaWYgKHR5cGVvZiBzdWJzY3JpcHRpb25JZCAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgcmVzcG9uc2VbJ3JlcXVlc3RJZCddID0gc3Vic2NyaXB0aW9uSWQ7XG4gICAgICB9XG4gICAgICBpZiAodHlwZW9mIHBhcnNlT2JqZWN0SlNPTiAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgbGV0IGZpZWxkcztcbiAgICAgICAgaWYgKHRoaXMuc3Vic2NyaXB0aW9uSW5mb3MuaGFzKHN1YnNjcmlwdGlvbklkKSkge1xuICAgICAgICAgIGZpZWxkcyA9IHRoaXMuc3Vic2NyaXB0aW9uSW5mb3MuZ2V0KHN1YnNjcmlwdGlvbklkKS5maWVsZHM7XG4gICAgICAgIH1cbiAgICAgICAgcmVzcG9uc2VbJ29iamVjdCddID0gdGhpcy5fdG9KU09OV2l0aEZpZWxkcyhwYXJzZU9iamVjdEpTT04sIGZpZWxkcyk7XG4gICAgICB9XG4gICAgICBDbGllbnQucHVzaFJlc3BvbnNlKHRoaXMucGFyc2VXZWJTb2NrZXQsIEpTT04uc3RyaW5naWZ5KHJlc3BvbnNlKSk7XG4gICAgfVxuICB9XG5cbiAgX3RvSlNPTldpdGhGaWVsZHMocGFyc2VPYmplY3RKU09OOiBhbnksIGZpZWxkczogYW55KTogRmxhdHRlbmVkT2JqZWN0RGF0YSB7XG4gICAgaWYgKCFmaWVsZHMpIHtcbiAgICAgIHJldHVybiBwYXJzZU9iamVjdEpTT047XG4gICAgfVxuICAgIGNvbnN0IGxpbWl0ZWRQYXJzZU9iamVjdCA9IHt9O1xuICAgIGZvciAoY29uc3QgZmllbGQgb2YgZGFmYXVsdEZpZWxkcykge1xuICAgICAgbGltaXRlZFBhcnNlT2JqZWN0W2ZpZWxkXSA9IHBhcnNlT2JqZWN0SlNPTltmaWVsZF07XG4gICAgfVxuICAgIGZvciAoY29uc3QgZmllbGQgb2YgZmllbGRzKSB7XG4gICAgICBpZiAoZmllbGQgaW4gcGFyc2VPYmplY3RKU09OKSB7XG4gICAgICAgIGxpbWl0ZWRQYXJzZU9iamVjdFtmaWVsZF0gPSBwYXJzZU9iamVjdEpTT05bZmllbGRdO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbGltaXRlZFBhcnNlT2JqZWN0O1xuICB9XG59XG5cbmV4cG9ydCB7XG4gIENsaWVudFxufVxuIl19