"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.IAPValidationRouter = undefined;

var _PromiseRouter = require("../PromiseRouter");

var _PromiseRouter2 = _interopRequireDefault(_PromiseRouter);

var _node = require("parse/node");

var _node2 = _interopRequireDefault(_node);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var request = require("request");
var rest = require("../rest");


// TODO move validation logic in IAPValidationController
const IAP_SANDBOX_URL = "https://sandbox.itunes.apple.com/verifyReceipt";
const IAP_PRODUCTION_URL = "https://buy.itunes.apple.com/verifyReceipt";

const APP_STORE_ERRORS = {
  21000: "The App Store could not read the JSON object you provided.",
  21002: "The data in the receipt-data property was malformed or missing.",
  21003: "The receipt could not be authenticated.",
  21004: "The shared secret you provided does not match the shared secret on file for your account.",
  21005: "The receipt server is not currently available.",
  21006: "This receipt is valid but the subscription has expired.",
  21007: "This receipt is from the test environment, but it was sent to the production environment for verification. Send it to the test environment instead.",
  21008: "This receipt is from the production environment, but it was sent to the test environment for verification. Send it to the production environment instead."
};

function appStoreError(status) {
  status = parseInt(status);
  var errorString = APP_STORE_ERRORS[status] || "unknown error.";
  return { status: status, error: errorString };
}

function validateWithAppStore(url, receipt) {
  return new Promise(function (fulfill, reject) {
    request.post({
      url: url,
      body: { "receipt-data": receipt },
      json: true
    }, function (err, res, body) {
      var status = body.status;
      if (status == 0) {
        // No need to pass anything, status is OK
        return fulfill();
      }
      // receipt is from test and should go to test
      return reject(body);
    });
  });
}

function getFileForProductIdentifier(productIdentifier, req) {
  return rest.find(req.config, req.auth, '_Product', { productIdentifier: productIdentifier }, undefined, req.info.clientSDK).then(function (result) {
    const products = result.results;
    if (!products || products.length != 1) {
      // Error not found or too many
      throw new _node2.default.Error(_node2.default.Error.OBJECT_NOT_FOUND, 'Object not found.');
    }

    var download = products[0].download;
    return Promise.resolve({ response: download });
  });
}

class IAPValidationRouter extends _PromiseRouter2.default {

  handleRequest(req) {
    let receipt = req.body.receipt;
    const productIdentifier = req.body.productIdentifier;

    if (!receipt || !productIdentifier) {
      // TODO: Error, malformed request
      throw new _node2.default.Error(_node2.default.Error.INVALID_JSON, "missing receipt or productIdentifier");
    }

    // Transform the object if there
    // otherwise assume it's in Base64 already
    if (typeof receipt == "object") {
      if (receipt["__type"] == "Bytes") {
        receipt = receipt.base64;
      }
    }

    if (process.env.TESTING == "1" && req.body.bypassAppStoreValidation) {
      return getFileForProductIdentifier(productIdentifier, req);
    }

    function successCallback() {
      return getFileForProductIdentifier(productIdentifier, req);
    }

    function errorCallback(error) {
      return Promise.resolve({ response: appStoreError(error.status) });
    }

    return validateWithAppStore(IAP_PRODUCTION_URL, receipt).then(() => {

      return successCallback();
    }, error => {
      if (error.status == 21007) {
        return validateWithAppStore(IAP_SANDBOX_URL, receipt).then(() => {
          return successCallback();
        }, error => {
          return errorCallback(error);
        });
      }

      return errorCallback(error);
    });
  }

  mountRoutes() {
    this.route("POST", "/validate_purchase", this.handleRequest);
  }
}
exports.IAPValidationRouter = IAPValidationRouter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0lBUFZhbGlkYXRpb25Sb3V0ZXIuanMiXSwibmFtZXMiOlsicmVxdWVzdCIsInJlcXVpcmUiLCJyZXN0IiwiSUFQX1NBTkRCT1hfVVJMIiwiSUFQX1BST0RVQ1RJT05fVVJMIiwiQVBQX1NUT1JFX0VSUk9SUyIsImFwcFN0b3JlRXJyb3IiLCJzdGF0dXMiLCJwYXJzZUludCIsImVycm9yU3RyaW5nIiwiZXJyb3IiLCJ2YWxpZGF0ZVdpdGhBcHBTdG9yZSIsInVybCIsInJlY2VpcHQiLCJQcm9taXNlIiwiZnVsZmlsbCIsInJlamVjdCIsInBvc3QiLCJib2R5IiwianNvbiIsImVyciIsInJlcyIsImdldEZpbGVGb3JQcm9kdWN0SWRlbnRpZmllciIsInByb2R1Y3RJZGVudGlmaWVyIiwicmVxIiwiZmluZCIsImNvbmZpZyIsImF1dGgiLCJ1bmRlZmluZWQiLCJpbmZvIiwiY2xpZW50U0RLIiwidGhlbiIsInJlc3VsdCIsInByb2R1Y3RzIiwicmVzdWx0cyIsImxlbmd0aCIsIkVycm9yIiwiT0JKRUNUX05PVF9GT1VORCIsImRvd25sb2FkIiwicmVzb2x2ZSIsInJlc3BvbnNlIiwiSUFQVmFsaWRhdGlvblJvdXRlciIsImhhbmRsZVJlcXVlc3QiLCJJTlZBTElEX0pTT04iLCJiYXNlNjQiLCJwcm9jZXNzIiwiZW52IiwiVEVTVElORyIsImJ5cGFzc0FwcFN0b3JlVmFsaWRhdGlvbiIsInN1Y2Nlc3NDYWxsYmFjayIsImVycm9yQ2FsbGJhY2siLCJtb3VudFJvdXRlcyIsInJvdXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7Ozs7QUFHQTs7Ozs7O0FBRkEsSUFBSUEsVUFBVUMsUUFBUSxTQUFSLENBQWQ7QUFDQSxJQUFJQyxPQUFPRCxRQUFRLFNBQVIsQ0FBWDs7O0FBR0E7QUFDQSxNQUFNRSxrQkFBa0IsZ0RBQXhCO0FBQ0EsTUFBTUMscUJBQXFCLDRDQUEzQjs7QUFFQSxNQUFNQyxtQkFBbUI7QUFDdkIsU0FBTyw0REFE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QixFQUErQ0MsR0FBL0MsQ0FBUDtBQUNEOztBQUVELGFBQVMwQixhQUFULENBQXVCeEMsS0FBdkIsRUFBOEI7QUFDNUIsYUFBT0ksUUFBUXlCLE9BQVIsQ0FBZ0IsRUFBQ0MsVUFBVWxDLGNBQWNJLE1BQU1ILE1BQXBCLENBQVgsRUFBaEIsQ0FBUDtBQUNEOztBQUVELFdBQU9JLHFCQUFxQlAsa0JBQXJCLEVBQXlDUyxPQUF6QyxFQUFrRGtCLElBQWxELENBQXVELE1BQU07O0FBRWxFLGFBQU9rQixpQkFBUDtBQUVELEtBSk0sRUFJSHZDLEtBQUQsSUFBVztBQUNaLFVBQUlBLE1BQU1ILE1BQU4sSUFBZ0IsS0FBcEIsRUFBMkI7QUFDekIsZUFBT0kscUJBQXFCUixlQUFyQixFQUFzQ1UsT0FBdEMsRUFBK0NrQixJQUEvQyxDQUFvRCxNQUFNO0FBQy9ELGlCQUFPa0IsaUJBQVA7QUFDRCxTQUZNLEVBRUh2QyxLQUFELElBQVc7QUFDWixpQkFBT3dDLGNBQWN4QyxLQUFkLENBQVA7QUFDRCxTQUpNLENBQVA7QUFNRDs7QUFFRCxhQUFPd0MsY0FBY3hDLEtBQWQsQ0FBUDtBQUNELEtBZk0sQ0FBUDtBQWdCRDs7QUFFRHlDLGdCQUFjO0FBQ1osU0FBS0MsS0FBTCxDQUFXLE1BQVgsRUFBa0Isb0JBQWxCLEVBQXdDLEtBQUtWLGFBQTdDO0FBQ0Q7QUFuRG9EO1FBQTFDRCxtQixHQUFBQSxtQiIsImZpbGUiOiJJQVBWYWxpZGF0aW9uUm91dGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFByb21pc2VSb3V0ZXIgZnJvbSAnLi4vUHJvbWlzZVJvdXRlcic7XG52YXIgcmVxdWVzdCA9IHJlcXVpcmUoXCJyZXF1ZXN0XCIpO1xudmFyIHJlc3QgPSByZXF1aXJlKFwiLi4vcmVzdFwiKTtcbmltcG9ydCBQYXJzZSBmcm9tICdwYXJzZS9ub2RlJztcblxuLy8gVE9ETyBtb3ZlIHZhbGlkYXRpb24gbG9naWMgaW4gSUFQVmFsaWRhdGlvbkNvbnRyb2xsZXJcbmNvbnN0IElBUF9TQU5EQk9YX1VSTCA9IFwiaHR0cHM6Ly9zYW5kYm94Lml0dW5lcy5hcHBsZS5jb20vdmVyaWZ5UmVjZWlwdFwiO1xuY29uc3QgSUFQX1BST0RVQ1RJT05fVVJMID0gXCJodHRwczovL2J1eS5pdHVuZXMuYXBwbGUuY29tL3ZlcmlmeVJlY2VpcHRcIjtcblxuY29uc3QgQVBQX1NUT1JFX0VSUk9SUyA9IHtcbiAgMjEwMDA6IFwiVGhlIEFwcCBTdG9yZSBjb3VsZCBub3QgcmVhZCB0aGUgSlNPTiBvYmplY3QgeW91IHByb3ZpZGVkLlwiLFxuICAyMTAwMjogXCJUaGUgZGF0YSBpbiB0aGUgcmVjZWlwdC1kYXRhIHByb3BlcnR5IHdhcyBtYWxmb3JtZWQgb3IgbWlzc2luZy5cIixcbiAgMjEwMDM6IFwiVGhlIHJlY2VpcHQgY291bGQgbm90IGJlIGF1dGhlbnRpY2F0ZWQuXCIsXG4gIDIxMDA0OiBcIlRoZSBzaGFyZWQgc2VjcmV0IHlvdSBwcm92aWRlZCBkb2VzIG5vdCBtYXRjaCB0aGUgc2hhcmVkIHNlY3JldCBvbiBmaWxlIGZvciB5b3VyIGFjY291bnQuXCIsXG4gIDIxMDA1OiBcIlRoZSByZWNlaXB0IHNlcnZlciBpcyBub3QgY3VycmVudGx5IGF2YWlsYWJsZS5cIixcbiAgMjEwMDY6IFwiVGhpcyByZWNlaXB0IGlzIHZhbGlkIGJ1dCB0aGUgc3Vic2NyaXB0aW9uIGhhcyBleHBpcmVkLlwiLFxuICAyMTAwNzogXCJUaGlzIHJlY2VpcHQgaXMgZnJvbSB0aGUgdGVzdCBlbnZpcm9ubWVudCwgYnV0IGl0IHdhcyBzZW50IHRvIHRoZSBwcm9kdWN0aW9uIGVudmlyb25tZW50IGZvciB2ZXJpZmljYXRpb24uIFNlbmQgaXQgdG8gdGhlIHRlc3QgZW52aXJvbm1lbnQgaW5zdGVhZC5cIixcbiAgMjEwMDg6IFwiVGhpcyByZWNlaXB0IGlzIGZyb20gdGhlIHByb2R1Y3Rpb24gZW52aXJvbm1lbnQsIGJ1dCBpdCB3YXMgc2VudCB0byB0aGUgdGVzdCBlbnZpcm9ubWVudCBmb3IgdmVyaWZpY2F0aW9uLiBTZW5kIGl0IHRvIHRoZSBwcm9kdWN0aW9uIGVudmlyb25tZW50IGluc3RlYWQuXCJcbn1cblxuZnVuY3Rpb24gYXBwU3RvcmVFcnJvcihzdGF0dXMpIHtcbiAgc3RhdHVzID0gcGFyc2VJbnQoc3RhdHVzKTtcbiAgdmFyIGVycm9yU3RyaW5nID0gQVBQX1NUT1JFX0VSUk9SU1tzdGF0dXNdIHx8IFwidW5rbm93biBlcnJvci5cIjtcbiAgcmV0dXJuIHsgc3RhdHVzOiBzdGF0dXMsIGVycm9yOiBlcnJvclN0cmluZyB9XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlV2l0aEFwcFN0b3JlKHVybCwgcmVjZWlwdCkge1xuICByZXR1cm4gbmV3IFByb21pc2UoZnVuY3Rpb24oZnVsZmlsbCwgcmVqZWN0KSB7XG4gICAgcmVxdWVzdC5wb3N0KHtcbiAgICAgIHVybDogdXJsLFxuICAgICAgYm9keTogeyBcInJlY2VpcHQtZGF0YVwiOiByZWNlaXB0IH0sXG4gICAgICBqc29uOiB0cnVlLFxuICAgIH0sIGZ1bmN0aW9uKGVyciwgcmVzLCBib2R5KSB7XG4gICAgICB2YXIgc3RhdHVzID0gYm9keS5zdGF0dXM7XG4gICAgICBpZiAoc3RhdHVzID09IDApIHtcbiAgICAgICAgLy8gTm8gbmVlZCB0byBwYXNzIGFueXRoaW5nLCBzdGF0dXMgaXMgT0tcbiAgICAgICAgcmV0dXJuIGZ1bGZpbGwoKTtcbiAgICAgIH1cbiAgICAgIC8vIHJlY2VpcHQgaXMgZnJvbSB0ZXN0IGFuZCBzaG91bGQgZ28gdG8gdGVzdFxuICAgICAgcmV0dXJuIHJlamVjdChib2R5KTtcbiAgICB9KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGdldEZpbGVGb3JQcm9kdWN0SWRlbnRpZmllcihwcm9kdWN0SWRlbnRpZmllciwgcmVxKSB7XG4gIHJldHVybiByZXN0LmZpbmQocmVxLmNvbmZpZywgcmVxLmF1dGgsICdfUHJvZHVjdCcsIHsgcHJvZHVjdElkZW50aWZpZXI6IHByb2R1Y3RJZGVudGlmaWVyIH0sIHVuZGVmaW5lZCwgcmVxLmluZm8uY2xpZW50U0RLKS50aGVuKGZ1bmN0aW9uKHJlc3VsdCl7XG4gICAgY29uc3QgcHJvZHVjdHMgPSByZXN1bHQucmVzdWx0cztcbiAgICBpZiAoIXByb2R1Y3RzIHx8IHByb2R1Y3RzLmxlbmd0aCAhPSAxKSB7XG4gICAgICAvLyBFcnJvciBub3QgZm91bmQgb3IgdG9vIG1hbnlcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5PQkpFQ1RfTk9UX0ZPVU5ELCAnT2JqZWN0IG5vdCBmb3VuZC4nKVxuICAgIH1cblxuICAgIHZhciBkb3dubG9hZCA9IHByb2R1Y3RzWzBdLmRvd25sb2FkO1xuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe3Jlc3BvbnNlOiBkb3dubG9hZH0pO1xuICB9KTtcbn1cblxuXG5leHBvcnQgY2xhc3MgSUFQVmFsaWRhdGlvblJvdXRlciBleHRlbmRzIFByb21pc2VSb3V0ZXIge1xuXG4gIGhhbmRsZVJlcXVlc3QocmVxKSB7XG4gICAgbGV0IHJlY2VpcHQgPSByZXEuYm9keS5yZWNlaXB0O1xuICAgIGNvbnN0IHByb2R1Y3RJZGVudGlmaWVyID0gcmVxLmJvZHkucHJvZHVjdElkZW50aWZpZXI7XG5cbiAgICBpZiAoIXJlY2VpcHQgfHwgISBwcm9kdWN0SWRlbnRpZmllcikge1xuICAgICAgLy8gVE9ETzogRXJyb3IsIG1hbGZvcm1lZCByZXF1ZXN0XG4gICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuSU5WQUxJRF9KU09OLCBcIm1pc3NpbmcgcmVjZWlwdCBvciBwcm9kdWN0SWRlbnRpZmllclwiKTtcbiAgICB9XG5cbiAgICAvLyBUcmFuc2Zvcm0gdGhlIG9iamVjdCBpZiB0aGVyZVxuICAgIC8vIG90aGVyd2lzZSBhc3N1bWUgaXQncyBpbiBCYXNlNjQgYWxyZWFkeVxuICAgIGlmICh0eXBlb2YgcmVjZWlwdCA9PSBcIm9iamVjdFwiKSB7XG4gICAgICBpZiAocmVjZWlwdFtcIl9fdHlwZVwiXSA9PSBcIkJ5dGVzXCIpIHtcbiAgICAgICAgcmVjZWlwdCA9IHJlY2VpcHQuYmFzZTY0O1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChwcm9jZXNzLmVudi5URVNUSU5HID09IFwiMVwiICYmIHJlcS5ib2R5LmJ5cGFzc0FwcFN0b3JlVmFsaWRhdGlvbikge1xuICAgICAgcmV0dXJuIGdldEZpbGVGb3JQcm9kdWN0SWRlbnRpZmllcihwcm9kdWN0SWRlbnRpZmllciwgcmVxKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBzdWNjZXNzQ2FsbGJhY2soKSB7XG4gICAgICByZXR1cm4gZ2V0RmlsZUZvclByb2R1Y3RJZGVudGlmaWVyKHByb2R1Y3RJZGVudGlmaWVyLCByZXEpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGVycm9yQ2FsbGJhY2soZXJyb3IpIHtcbiAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe3Jlc3BvbnNlOiBhcHBTdG9yZUVycm9yKGVycm9yLnN0YXR1cykgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHZhbGlkYXRlV2l0aEFwcFN0b3JlKElBUF9QUk9EVUNUSU9OX1VSTCwgcmVjZWlwdCkudGhlbigoKSA9PiB7XG5cbiAgICAgIHJldHVybiBzdWNjZXNzQ2FsbGJhY2soKTtcblxuICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgaWYgKGVycm9yLnN0YXR1cyA9PSAyMTAwNykge1xuICAgICAgICByZXR1cm4gdmFsaWRhdGVXaXRoQXBwU3RvcmUoSUFQX1NBTkRCT1hfVVJMLCByZWNlaXB0KS50aGVuKCgpID0+IHtcbiAgICAgICAgICByZXR1cm4gc3VjY2Vzc0NhbGxiYWNrKCk7XG4gICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgIHJldHVybiBlcnJvckNhbGxiYWNrKGVycm9yKTtcbiAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZXJyb3JDYWxsYmFjayhlcnJvcik7XG4gICAgfSk7XG4gIH1cblxuICBtb3VudFJvdXRlcygpIHtcbiAgICB0aGlzLnJvdXRlKFwiUE9TVFwiLFwiL3ZhbGlkYXRlX3B1cmNoYXNlXCIsIHRoaXMuaGFuZGxlUmVxdWVzdCk7XG4gIH1cbn1cbiJdfQ==