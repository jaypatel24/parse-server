'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ClassesRouter = undefined;

var _PromiseRouter = require('../PromiseRouter');

var _PromiseRouter2 = _interopRequireDefault(_PromiseRouter);

var _rest = require('../rest');

var _rest2 = _interopRequireDefault(_rest);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _node = require('parse/node');

var _node2 = _interopRequireDefault(_node);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const ALLOWED_GET_QUERY_KEYS = ['keys', 'include'];

class ClassesRouter extends _PromiseRouter2.default {

  className(req) {
    return req.params.className;
  }

  handleFind(req) {
    const body = Object.assign(req.body, ClassesRouter.JSONFromQuery(req.query));
    const options = ClassesRouter.optionsFromBody(body);
    if (req.config.maxLimit && body.limit > req.config.maxLimit) {
      // Silently replace the limit on the query with the max configured
      options.limit = Number(req.config.maxLimit);
    }
    if (body.redirectClassNameForKey) {
      options.redirectClassNameForKey = String(body.redirectClassNameForKey);
    }
    if (typeof body.where === 'string') {
      body.where = JSON.parse(body.where);
    }
    return _rest2.default.find(req.config, req.auth, this.className(req), body.where, options, req.info.clientSDK).then(response => {
      return { response: response };
    });
  }

  // Returns a promise for a {response} object.
  handleGet(req) {
    const body = Object.assign(req.body, ClassesRouter.JSONFromQuery(req.query));
    const options = {};

    for (const key of Object.keys(body)) {
      if (ALLOWED_GET_QUERY_KEYS.indexOf(key) === -1) {
        throw new _node2.default.Error(_node2.default.Error.INVALID_QUERY, 'Improper encode of parameter');
      }
    }

    if (typeof body.keys == 'string') {
      options.keys = body.keys;
    }
    if (body.include) {
      options.include = String(body.include);
    }

    return _rest2.default.get(req.config, req.auth, this.className(req), req.params.objectId, options, req.info.clientSDK).then(response => {
      if (!response.results || response.results.length == 0) {
        throw new _node2.default.Error(_node2.default.Error.OBJECT_NOT_FOUND, 'Object not found.');
      }

      if (this.className(req) === "_User") {

        delete response.results[0].sessionToken;

        const user = response.results[0];

        if (req.auth.user && user.objectId == req.auth.user.id) {
          // Force the session token
          response.results[0].sessionToken = req.info.sessionToken;
        }
      }
      return { response: response.results[0] };
    });
  }

  handleCreate(req) {
    return _rest2.default.create(req.config, req.auth, this.className(req), req.body, req.info.clientSDK);
  }

  handleUpdate(req) {
    const where = { objectId: req.params.objectId };
    return _rest2.default.update(req.config, req.auth, this.className(req), where, req.body, req.info.clientSDK);
  }

  handleDelete(req) {
    return _rest2.default.del(req.config, req.auth, this.className(req), req.params.objectId, req.info.clientSDK).then(() => {
      return { response: {} };
    });
  }

  static JSONFromQuery(query) {
    const json = {};
    for (const [key, value] of _lodash2.default.entries(query)) {
      try {
        json[key] = JSON.parse(value);
      } catch (e) {
        json[key] = value;
      }
    }
    return json;
  }

  static optionsFromBody(body) {
    const allowConstraints = ['skip', 'limit', 'order', 'count', 'keys', 'include', 'includeAll', 'redirectClassNameForKey', 'where'];

    for (const key of Object.keys(body)) {
      if (allowConstraints.indexOf(key) === -1) {
        throw new _node2.default.Error(_node2.default.Error.INVALID_QUERY, `Invalid parameter for query: ${key}`);
      }
    }
    const options = {};
    if (body.skip) {
      options.skip = Number(body.skip);
    }
    if (body.limit || body.limit === 0) {
      options.limit = Number(body.limit);
    } else {
      options.limit = Number(100);
    }
    if (body.order) {
      options.order = String(body.order);
    }
    if (body.count) {
      options.count = true;
    }
    if (typeof body.keys == 'string') {
      options.keys = body.keys;
    }
    if (body.include) {
      options.include = String(body.include);
    }
    if (body.includeAll) {
      options.includeAll = true;
    }
    return options;
  }

  mountRoutes() {
    this.route('GET', '/classes/:className', req => {
      return this.handleFind(req);
    });
    this.route('GET', '/classes/:className/:objectId', req => {
      return this.handleGet(req);
    });
    this.route('POST', '/classes/:className', req => {
      return this.handleCreate(req);
    });
    this.route('PUT', '/classes/:className/:objectId', req => {
      return this.handleUpdate(req);
    });
    this.route('DELETE', '/classes/:className/:objectId', req => {
      return this.handleDelete(req);
    });
  }
}

exports.ClassesRouter = ClassesRouter;
exports.default = ClassesRouter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0NsYXNzZXNSb3V0ZXIuanMiXSwibmFtZXMiOlsiQUxMT1dFRF9HRVRfUVVFUllfS0VZUyIsIkNsYXNzZXNSb3V0ZXIiLCJjbGFzc05hbWUiLCJyZXEiLCJwYXJhbXMiLCJoYW5kbGVGaW5kIiwiYm9keSIsIk9iamVjdCIsImFzc2lnbiIsIkpTT05Gcm9tUXVlcnkiLCJxdWVyeSIsIm9wdGlvbnMiLCJvcHRpb25zRnJvbUJvZHkiLCJjb25maWciLCJtYXhMaW1pdCIsImxpbWl0IiwiTnVtYmVyIiwicmVkaXJlY3RDbGFzc05hbWVGb3JLZXkiLCJTdHJpbmciLCJ3aGVyZSIsIkpTT04iLCJwYXJzZSIsImZpbmQiLCJhdXRoIiwiaW5mbyIsImNsaWVudFNESyIsInRoZW4iLCJyZXNwb25zZSIsImhhbmRsZUdldCIsImtleSIsImtleXMiLCJpbmRleE9mIiwiRXJyb3IiLCJJTlZBTElEX1FVRVJZIiwiaW5jbHVkZSIsImdldCIsIm9iamVjdElkIiwicmVzdWx0cyIsImxlbmd0aCIsIk9CSkVDVF9OT1RfRk9VTkQiLCJzZXNzaW9uVG9rZW4iLCJ1c2VyIiwiaWQiLCJoYW5kbGVDcmVhdGUiLCJjcmVhdGUiLCJoYW5kbGVVcGRhdGUiLCJ1cGRhdGUiLCJoYW5kbGVEZWxldGUiLCJkZWwiLCJqc29uIiwidmFsdWUiLCJlbnRyaWVzIiwiZSIsImFsbG93Q29uc3RyYWludHMiLCJza2lwIiwib3JkZXIiLCJjb3VudCIsImluY2x1ZGVBbGwiLCJtb3VudFJvdXRlcyIsInJvdXRlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7OztBQUVBLE1BQU1BLHlCQUF5QixDQUFDLE1BQUQsRUFBUyxTQUFULENBQS9COztBQUVPLE1BQU1DLGFBQU4saUNBQTBDOztBQUUvQ0MsWUFBVUMsR0FBVixFQUFlO0FBQ2IsV0FBT0EsSUFBSUMsTUFBSixDQUFXRixTQUFsQjtBQUNEOztBQUVERyxhQUFXRixH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QUFrQiwrQkFBbEIsRUFBb0R4RCxHQUFELElBQVM7QUFBRSxhQUFPLEtBQUswQyxZQUFMLENBQWtCMUMsR0FBbEIsQ0FBUDtBQUFnQyxLQUE5RjtBQUNBLFNBQUt3RCxLQUFMLENBQVcsUUFBWCxFQUFzQiwrQkFBdEIsRUFBd0R4RCxHQUFELElBQVM7QUFBRSxhQUFPLEtBQUs0QyxZQUFMLENBQWtCNUMsR0FBbEIsQ0FBUDtBQUFnQyxLQUFsRztBQUNEO0FBdEk4Qzs7UUFBcENGLGEsR0FBQUEsYTtrQkF5SUVBLGEiLCJmaWxlIjoiQ2xhc3Nlc1JvdXRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IFByb21pc2VSb3V0ZXIgZnJvbSAnLi4vUHJvbWlzZVJvdXRlcic7XG5pbXBvcnQgcmVzdCAgICAgICAgICBmcm9tICcuLi9yZXN0JztcbmltcG9ydCBfICAgICAgICAgICAgIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgUGFyc2UgICAgICAgICBmcm9tICdwYXJzZS9ub2RlJztcblxuY29uc3QgQUxMT1dFRF9HRVRfUVVFUllfS0VZUyA9IFsna2V5cycsICdpbmNsdWRlJ107XG5cbmV4cG9ydCBjbGFzcyBDbGFzc2VzUm91dGVyIGV4dGVuZHMgUHJvbWlzZVJvdXRlciB7XG5cbiAgY2xhc3NOYW1lKHJlcSkge1xuICAgIHJldHVybiByZXEucGFyYW1zLmNsYXNzTmFtZTtcbiAgfVxuXG4gIGhhbmRsZUZpbmQocmVxKSB7XG4gICAgY29uc3QgYm9keSA9IE9iamVjdC5hc3NpZ24ocmVxLmJvZHksIENsYXNzZXNSb3V0ZXIuSlNPTkZyb21RdWVyeShyZXEucXVlcnkpKTtcbiAgICBjb25zdCBvcHRpb25zID0gQ2xhc3Nlc1JvdXRlci5vcHRpb25zRnJvbUJvZHkoYm9keSk7XG4gICAgaWYgKHJlcS5jb25maWcubWF4TGltaXQgJiYgKGJvZHkubGltaXQgPiByZXEuY29uZmlnLm1heExpbWl0KSkge1xuICAgICAgLy8gU2lsZW50bHkgcmVwbGFjZSB0aGUgbGltaXQgb24gdGhlIHF1ZXJ5IHdpdGggdGhlIG1heCBjb25maWd1cmVkXG4gICAgICBvcHRpb25zLmxpbWl0ID0gTnVtYmVyKHJlcS5jb25maWcubWF4TGltaXQpO1xuICAgIH1cbiAgICBpZiAoYm9keS5yZWRpcmVjdENsYXNzTmFtZUZvcktleSkge1xuICAgICAgb3B0aW9ucy5yZWRpcmVjdENsYXNzTmFtZUZvcktleSA9IFN0cmluZyhib2R5LnJlZGlyZWN0Q2xhc3NOYW1lRm9yS2V5KTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBib2R5LndoZXJlID09PSAnc3RyaW5nJykge1xuICAgICAgYm9keS53aGVyZSA9IEpTT04ucGFyc2UoYm9keS53aGVyZSk7XG4gICAgfVxuICAgIHJldHVybiByZXN0LmZpbmQocmVxLmNvbmZpZywgcmVxLmF1dGgsIHRoaXMuY2xhc3NOYW1lKHJlcSksIGJvZHkud2hlcmUsIG9wdGlvbnMsIHJlcS5pbmZvLmNsaWVudFNESylcbiAgICAgIC50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgICByZXR1cm4geyByZXNwb25zZTogcmVzcG9uc2UgfTtcbiAgICAgIH0pO1xuICB9XG5cbiAgLy8gUmV0dXJucyBhIHByb21pc2UgZm9yIGEge3Jlc3BvbnNlfSBvYmplY3QuXG4gIGhhbmRsZUdldChyZXEpIHtcbiAgICBjb25zdCBib2R5ID0gT2JqZWN0LmFzc2lnbihyZXEuYm9keSwgQ2xhc3Nlc1JvdXRlci5KU09ORnJvbVF1ZXJ5KHJlcS5xdWVyeSkpO1xuICAgIGNvbnN0IG9wdGlvbnMgPSB7fTtcblxuICAgIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKGJvZHkpKSB7XG4gICAgICBpZiAoQUxMT1dFRF9HRVRfUVVFUllfS0VZUy5pbmRleE9mKGtleSkgPT09IC0xKSB7XG4gICAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5JTlZBTElEX1FVRVJZLCAnSW1wcm9wZXIgZW5jb2RlIG9mIHBhcmFtZXRlcicpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0eXBlb2YgYm9keS5rZXlzID09ICdzdHJpbmcnKSB7XG4gICAgICBvcHRpb25zLmtleXMgPSBib2R5LmtleXM7XG4gICAgfVxuICAgIGlmIChib2R5LmluY2x1ZGUpIHtcbiAgICAgIG9wdGlvbnMuaW5jbHVkZSA9IFN0cmluZyhib2R5LmluY2x1ZGUpO1xuICAgIH1cblxuICAgIHJldHVybiByZXN0LmdldChyZXEuY29uZmlnLCByZXEuYXV0aCwgdGhpcy5jbGFzc05hbWUocmVxKSwgcmVxLnBhcmFtcy5vYmplY3RJZCwgb3B0aW9ucywgcmVxLmluZm8uY2xpZW50U0RLKVxuICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgIGlmICghcmVzcG9uc2UucmVzdWx0cyB8fCByZXNwb25zZS5yZXN1bHRzLmxlbmd0aCA9PSAwKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLk9CSkVDVF9OT1RfRk9VTkQsICdPYmplY3Qgbm90IGZvdW5kLicpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuY2xhc3NOYW1lKHJlcSkgPT09IFwiX1VzZXJcIikge1xuXG4gICAgICAgICAgZGVsZXRlIHJlc3BvbnNlLnJlc3VsdHNbMF0uc2Vzc2lvblRva2VuO1xuXG4gICAgICAgICAgY29uc3QgdXNlciA9ICByZXNwb25zZS5yZXN1bHRzWzBdO1xuXG4gICAgICAgICAgaWYgKHJlcS5hdXRoLnVzZXIgJiYgdXNlci5vYmplY3RJZCA9PSByZXEuYXV0aC51c2VyLmlkKSB7XG4gICAgICAgICAgICAvLyBGb3JjZSB0aGUgc2Vzc2lvbiB0b2tlblxuICAgICAgICAgICAgcmVzcG9uc2UucmVzdWx0c1swXS5zZXNzaW9uVG9rZW4gPSByZXEuaW5mby5zZXNzaW9uVG9rZW47XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7IHJlc3BvbnNlOiByZXNwb25zZS5yZXN1bHRzWzBdIH07XG4gICAgICB9KTtcbiAgfVxuXG4gIGhhbmRsZUNyZWF0ZShyZXEpIHtcbiAgICByZXR1cm4gcmVzdC5jcmVhdGUocmVxLmNvbmZpZywgcmVxLmF1dGgsIHRoaXMuY2xhc3NOYW1lKHJlcSksIHJlcS5ib2R5LCByZXEuaW5mby5jbGllbnRTREspO1xuICB9XG5cbiAgaGFuZGxlVXBkYXRlKHJlcSkge1xuICAgIGNvbnN0IHdoZXJlID0geyBvYmplY3RJZDogcmVxLnBhcmFtcy5vYmplY3RJZCB9XG4gICAgcmV0dXJuIHJlc3QudXBkYXRlKHJlcS5jb25maWcsIHJlcS5hdXRoLCB0aGlzLmNsYXNzTmFtZShyZXEpLCB3aGVyZSwgcmVxLmJvZHksIHJlcS5pbmZvLmNsaWVudFNESyk7XG4gIH1cblxuICBoYW5kbGVEZWxldGUocmVxKSB7XG4gICAgcmV0dXJuIHJlc3QuZGVsKHJlcS5jb25maWcsIHJlcS5hdXRoLCB0aGlzLmNsYXNzTmFtZShyZXEpLCByZXEucGFyYW1zLm9iamVjdElkLCByZXEuaW5mby5jbGllbnRTREspXG4gICAgICAudGhlbigoKSA9PiB7XG4gICAgICAgIHJldHVybiB7cmVzcG9uc2U6IHt9fTtcbiAgICAgIH0pO1xuICB9XG5cbiAgc3RhdGljIEpTT05Gcm9tUXVlcnkocXVlcnkpIHtcbiAgICBjb25zdCBqc29uID0ge307XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgXy5lbnRyaWVzKHF1ZXJ5KSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAganNvbltrZXldID0gSlNPTi5wYXJzZSh2YWx1ZSk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGpzb25ba2V5XSA9IHZhbHVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4ganNvblxuICB9XG5cbiAgc3RhdGljIG9wdGlvbnNGcm9tQm9keShib2R5KSB7XG4gICAgY29uc3QgYWxsb3dDb25zdHJhaW50cyA9IFsnc2tpcCcsICdsaW1pdCcsICdvcmRlcicsICdjb3VudCcsICdrZXlzJyxcbiAgICAgICdpbmNsdWRlJywgJ2luY2x1ZGVBbGwnLCAncmVkaXJlY3RDbGFzc05hbWVGb3JLZXknLCAnd2hlcmUnXTtcblxuICAgIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKGJvZHkpKSB7XG4gICAgICBpZiAoYWxsb3dDb25zdHJhaW50cy5pbmRleE9mKGtleSkgPT09IC0xKSB7XG4gICAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5JTlZBTElEX1FVRVJZLCBgSW52YWxpZCBwYXJhbWV0ZXIgZm9yIHF1ZXJ5OiAke2tleX1gKTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3Qgb3B0aW9ucyA9IHt9O1xuICAgIGlmIChib2R5LnNraXApIHtcbiAgICAgIG9wdGlvbnMuc2tpcCA9IE51bWJlcihib2R5LnNraXApO1xuICAgIH1cbiAgICBpZiAoYm9keS5saW1pdCB8fCBib2R5LmxpbWl0ID09PSAwKSB7XG4gICAgICBvcHRpb25zLmxpbWl0ID0gTnVtYmVyKGJvZHkubGltaXQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBvcHRpb25zLmxpbWl0ID0gTnVtYmVyKDEwMCk7XG4gICAgfVxuICAgIGlmIChib2R5Lm9yZGVyKSB7XG4gICAgICBvcHRpb25zLm9yZGVyID0gU3RyaW5nKGJvZHkub3JkZXIpO1xuICAgIH1cbiAgICBpZiAoYm9keS5jb3VudCkge1xuICAgICAgb3B0aW9ucy5jb3VudCA9IHRydWU7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgYm9keS5rZXlzID09ICdzdHJpbmcnKSB7XG4gICAgICBvcHRpb25zLmtleXMgPSBib2R5LmtleXM7XG4gICAgfVxuICAgIGlmIChib2R5LmluY2x1ZGUpIHtcbiAgICAgIG9wdGlvbnMuaW5jbHVkZSA9IFN0cmluZyhib2R5LmluY2x1ZGUpO1xuICAgIH1cbiAgICBpZiAoYm9keS5pbmNsdWRlQWxsKSB7XG4gICAgICBvcHRpb25zLmluY2x1ZGVBbGwgPSB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gb3B0aW9ucztcbiAgfVxuXG4gIG1vdW50Um91dGVzKCkge1xuICAgIHRoaXMucm91dGUoJ0dFVCcsICcvY2xhc3Nlcy86Y2xhc3NOYW1lJywgKHJlcSkgPT4geyByZXR1cm4gdGhpcy5oYW5kbGVGaW5kKHJlcSk7IH0pO1xuICAgIHRoaXMucm91dGUoJ0dFVCcsICcvY2xhc3Nlcy86Y2xhc3NOYW1lLzpvYmplY3RJZCcsIChyZXEpID0+IHsgcmV0dXJuIHRoaXMuaGFuZGxlR2V0KHJlcSk7IH0pO1xuICAgIHRoaXMucm91dGUoJ1BPU1QnLCAnL2NsYXNzZXMvOmNsYXNzTmFtZScsIChyZXEpID0+IHsgcmV0dXJuIHRoaXMuaGFuZGxlQ3JlYXRlKHJlcSk7IH0pO1xuICAgIHRoaXMucm91dGUoJ1BVVCcsICcvY2xhc3Nlcy86Y2xhc3NOYW1lLzpvYmplY3RJZCcsIChyZXEpID0+IHsgcmV0dXJuIHRoaXMuaGFuZGxlVXBkYXRlKHJlcSk7IH0pO1xuICAgIHRoaXMucm91dGUoJ0RFTEVURScsICAnL2NsYXNzZXMvOmNsYXNzTmFtZS86b2JqZWN0SWQnLCAocmVxKSA9PiB7IHJldHVybiB0aGlzLmhhbmRsZURlbGV0ZShyZXEpOyB9KTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBDbGFzc2VzUm91dGVyO1xuIl19