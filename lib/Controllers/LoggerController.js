'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.LoggerController = exports.LogOrder = exports.LogLevel = undefined;

var _node = require('parse/node');

var _AdaptableController = require('./AdaptableController');

var _AdaptableController2 = _interopRequireDefault(_AdaptableController);

var _LoggerAdapter = require('../Adapters/Logger/LoggerAdapter');

var _url = require('url');

var _url2 = _interopRequireDefault(_url);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const MILLISECONDS_IN_A_DAY = 24 * 60 * 60 * 1000;
const LOG_STRING_TRUNCATE_LENGTH = 1000;
const truncationMarker = '... (truncated)';

const LogLevel = exports.LogLevel = {
  INFO: 'info',
  ERROR: 'error'
};

const LogOrder = exports.LogOrder = {
  DESCENDING: 'desc',
  ASCENDING: 'asc'
};

const logLevels = ['error', 'warn', 'info', 'debug', 'verbose', 'silly'];

class LoggerController extends _AdaptableController2.default {

  constructor(adapter, appId, options = { logLevel: 'info' }) {
    super(adapter, appId, options);
    let level = 'info';
    if (options.verbose) {
      level = 'verbose';
    }
    if (options.logLevel) {
      level = options.logLevel;
    }
    const index = logLevels.indexOf(level); // info by default
    logLevels.forEach((level, levelIndex) => {
      if (levelIndex > index) {
        // silence the levels that are > maxIndex
        this[level] = () => {};
      }
    });
  }

  maskSensitiveUrl(urlString) {
    const urlObj = _url2.default.parse(urlString, true);
    const query = urlObj.query;
    let sanitizedQuery = '?';

    for (const key in query) {
      if (key !== 'password') {
        // normal value
        sanitizedQuery += key + '=' + query[key] + '&';
      } else {
        // password value, redact it
        sanitizedQuery += key + '=' + '********' + '&';
      }
    }

    // trim last character, ? or &
    sanitizedQuery = sanitizedQuery.slice(0, -1);

    // return original path name with sanitized params attached
    return urlObj.pathname + sanitizedQuery;
  }

  maskSensitive(argArray) {
    return argArray.map(e => {
      if (!e) {
        return e;
      }

      if (typeof e === 'string') {
        return e.replace(/(password".?:.?")[^"]*"/g, '$1********"');
      }
      // else it is an object...

      // check the url
      if (e.url) {
        // for strings
        if (typeof e.url === 'string') {
          e.url = this.maskSensitiveUrl(e.url);
        } else if (Array.isArray(e.url)) {
          // for strings in array
          e.url = e.url.map(item => {
            if (typeof item === 'string') {
              return this.maskSensitiveUrl(item);
            }

            return item;
          });
        }
      }

      if (e.body) {
        for (const key of Object.keys(e.body)) {
          if (key === 'password') {
            e.body[key] = '********';
            break;
          }
        }
      }

      if (e.params) {
        for (const key of Object.keys(e.params)) {
          if (key === 'password') {
            e.params[key] = '********';
            break;
          }
        }
      }

      return e;
    });
  }

  log(level, args) {
    // make the passed in arguments object an array with the spread operator
    args = this.maskSensitive([...args]);
    args = [].concat(level, args.map(arg => {
      if (typeof arg === 'function') {
        return arg();
      }
      return arg;
    }));
    this.adapter.log.apply(this.adapter, args);
  }

  info() {
    return this.log('info', arguments);
  }

  error() {
    return this.log('error', arguments);
  }

  warn() {
    return this.log('warn', arguments);
  }

  verbose() {
    return this.log('verbose', arguments);
  }

  debug() {
    return this.log('debug', arguments);
  }

  silly() {
    return this.log('silly', arguments);
  }

  logRequest({
    method,
    url,
    headers,
    body
  }) {
    this.verbose(() => {
      const stringifiedBody = JSON.stringify(body, null, 2);
      return `REQUEST for [${method}] ${url}: ${stringifiedBody}`;
    }, {
      method,
      url,
      headers,
      body
    });
  }

  logResponse({
    method,
    url,
    result
  }) {
    this.verbose(() => {
      const stringifiedResponse = JSON.stringify(result, null, 2);
      return `RESPONSE from [${method}] ${url}: ${stringifiedResponse}`;
    }, { result: result });
  }
  // check that date input is valid
  static validDateTime(date) {
    if (!date) {
      return null;
    }
    date = new Date(date);

    if (!isNaN(date.getTime())) {
      return date;
    }

    return null;
  }

  truncateLogMessage(string) {
    if (string && string.length > LOG_STRING_TRUNCATE_LENGTH) {
      const truncated = string.substring(0, LOG_STRING_TRUNCATE_LENGTH) + truncationMarker;
      return truncated;
    }

    return string;
  }

  static parseOptions(options = {}) {
    const from = LoggerController.validDateTime(options.from) || new Date(Date.now() - 7 * MILLISECONDS_IN_A_DAY);
    const until = LoggerController.validDateTime(options.until) || new Date();
    const size = Number(options.size) || 10;
    const order = options.order || LogOrder.DESCENDING;
    const level = options.level || LogLevel.INFO;

    return {
      from,
      until,
      size,
      order,
      level
    };
  }

  // Returns a promise for a {response} object.
  // query params:
  // level (optional) Level of logging you want to query for (info || error)
  // from (optional) Start time for the search. Defaults to 1 week ago.
  // until (optional) End time for the search. Defaults to current time.
  // order (optional) Direction of results returned, either “asc” or “desc”. Defaults to “desc”.
  // size (optional) Number of rows returned by search. Defaults to 10
  getLogs(options = {}) {
    if (!this.adapter) {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, 'Logger adapter is not available');
    }
    if (typeof this.adapter.query !== 'function') {
      throw new _node.Parse.Error(_node.Parse.Error.PUSH_MISCONFIGURED, 'Querying logs is not supported with this adapter');
    }
    options = LoggerController.parseOptions(options);
    return this.adapter.query(options);
  }

  expectedAdapterType() {
    return _LoggerAdapter.LoggerAdapter;
  }
}

exports.LoggerController = LoggerController;
exports.default = LoggerController;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Db250cm9sbGVycy9Mb2dnZXJDb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbIk1JTExJU0VDT05EU19JTl9BX0RBWSIsIkxPR19TVFJJTkdfVFJVTkNBVEVfTEVOR1RIIiwidHJ1bmNhdGlvbk1hcmtlciIsIkxvZ0xldmVsIiwiSU5GTyIsIkVSUk9SIiwiTG9nT3JkZXIiLCJERVNDRU5ESU5HIiwiQVNDRU5ESU5HIiwibG9nTGV2ZWxzIiwiTG9nZ2VyQ29udHJvbGxlciIsImNvbnN0cnVjdG9yIiwiYWRhcHRlciIsImFwcElkIiwib3B0aW9ucyIsImxvZ0xldmVsIiwibGV2ZWwiLCJ2ZXJib3NlIiwiaW5kZXgiLCJpbmRleE9mIiwiZm9yRWFjaCIsImxldmVsSW5kZXgiLCJtYXNrU2Vuc2l0aXZlVXJsIiwidXJsU3RyaW5nIiwidXJsT2JqIiwicGFyc2UiLCJxdWVyeSIsInNhbml0aXplZFF1ZXJ5Iiwia2V5Iiwic2xpY2UiLCJwYXRobmFtZSIsIm1hc2tTZW5zaXRpdmUiLCJhcmdBcnJheSIsIm1hcCIsImUiLCJyZXBsYWNlIiwidXJsIiwiQXJyYXkiLCJpc0FycmF5IiwiaXRlbSIsImJvZHkiLCJPYmplY3QiLCJrZXlzIiwicGFyYW1zIiwibG9nIiwiYXJncyIsImNvbmNhdCIsImFyZyIsImFwcGx5IiwiaW5mbyIsImFyZ3VtZW50cyIsImVycm9yIiwid2FybiIsImRlYnVnIiwic2lsbHkiLCJsb2dSZXF1ZXN0IiwibWV0aG9kIiwiaGVhZGVycyIsInN0cmluZ2lmaWVkQm9keSIsIkpTT04iLCJzdHJpbmdpZnkiLCJsb2dSZXNwb25zZSIsInJlc3VsdCIsInN0cmluZ2lmaWVkUmVzcG9uc2UiLCJ2YWxpZERhdGVUaW1lIiwiZGF0ZSIsIkRhdGUiLCJpc05hTiIsImdldFRpbWUiLCJ0cnVuY2F0ZUxvZ01lc3NhZ2UiLCJzdHJpbmciLCJsZW5ndGgiLCJ0cnVuY2F0ZWQiLCJzdWJzdHJpbmciLCJwYXJzZU9wdGlvbnMiLCJmcm9tIiwibm93IiwidW50aWwiLCJzaXplIiwiTnVtYmVyIiwib3JkZXIiLCJnZXRMb2dzIiwiRXJyb3IiLCJQVVNIX01JU0NPTkZJR1VSRUQiLCJleHBlY3RlZEFkYXB0ZXJUeXBlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7Ozs7O0FBRUEsTUFBTUEsd0JBQXdCLEtBQUssRUFBTCxHQUFVLEVBQVYsR0FBZSxJQUE3QztBQUNBLE1BQU1DLDZCQUE2QixJQUFuQztBQUNBLE1BQU1DLG1CQUFtQixpQkFBekI7O0FBRU8sTUFBTUMsOEJBQVc7QUFDdEJDLFFBQU0sTUFEZ0I7QUFFdEJDLFNBQU87QUFGZSxDQUFqQjs7QUFLQSxNQUFNQyw4QkFBVztBQUN0QkMsY0FBWSxNQURVO0FBRXRCQyxhQUFXO0FBRlcsQ0FBakI7O0FBS1AsTUFBTUMsWUFBWSxDQUNoQixPQURnQixFQUVoQixNQUZnQixFQUdoQixNQUhnQixFQUloQixPQUpnQixFQUtoQixTQUxnQixFQU1oQixPQU5nQixDQUFsQjs7QUFTTyxNQUFNQyxnQkFBTix1Q0FBbUQ7O0FBRXhEQyxjQUFZQyxPQUFaLEVBQXFCQyxLQUFyQixFQUE0QkMsVUFBVSxFQUFDQyxVQUFVLE1BQVgsRUFBdEMsRUFBMEQ7QUFDeEQsVUFBTUgsT0FBTixFQUFlQyxLQUFmLEVBQXNCQyxPQUF0QjtBQUNBLFFBQUlFLFFBQVEsTUFBWjtBQUNBLFFBQUlGLFFBQVFHLE9BQVosRUFBcUI7QUFDbkJELGNBQVEsU0FBUjtBQUNEO0FBQ0QsUUFBSUYsUUFBUUMsUUFBWixFQUFzQjtBQUNwQkMsY0FBUUYsUUFBUUMsUUFBaEI7QUFDRDtBQUNELFVBQU1HLFFBQVFULFVBQVVVLE9BQVYsQ0FBa0JILEtBQWxCLENBQWQsQ0FUd0QsQ0FTaEI7QUFDeENQLGNBQVVXLE9BQVYsQ0FBa0IsQ0FBQ0osS0FBRCxFQUFRSyxVQUFSLEtBQXVCO0FBQ3ZDLFVBQUlBLGFBQWFILEtBQWpCLEVBQXdCO0FBQUU7QUFDeEIsYUFBS0YsS0FBTCxJQUFjLE1BQU0sQ0FBRSxD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RUxFLFdBRks7QUFHTEMsVUFISztBQUlMRSxXQUpLO0FBS0xoRTtBQUxLLEtBQVA7QUFPRDs7QUFFRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBaUUsVUFBUW5FLFVBQVUsRUFBbEIsRUFBc0I7QUFDcEIsUUFBSSxDQUFDLEtBQUtGLE9BQVYsRUFBbUI7QUFDakIsWUFBTSxJQUFJLFlBQU1zRSxLQUFWLENBQWdCLFlBQU1BLEtBQU4sQ0FBWUMsa0JBQTVCLEVBQ0osaUNBREksQ0FBTjtBQUVEO0FBQ0QsUUFBSSxPQUFPLEtBQUt2RSxPQUFMLENBQWFjLEtBQXBCLEtBQThCLFVBQWxDLEVBQThDO0FBQzVDLFlBQU0sSUFBSSxZQUFNd0QsS0FBVixDQUFnQixZQUFNQSxLQUFOLENBQVlDLGtCQUE1QixFQUNKLGtEQURJLENBQU47QUFFRDtBQUNEckUsY0FBVUosaUJBQWlCZ0UsWUFBakIsQ0FBOEI1RCxPQUE5QixDQUFWO0FBQ0EsV0FBTyxLQUFLRixPQUFMLENBQWFjLEtBQWIsQ0FBbUJaLE9BQW5CLENBQVA7QUFDRDs7QUFFRHNFLHdCQUFzQjtBQUNwQjtBQUNEO0FBdk51RDs7UUFBN0MxRSxnQixHQUFBQSxnQjtrQkEwTkVBLGdCIiwiZmlsZSI6IkxvZ2dlckNvbnRyb2xsZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQYXJzZSB9IGZyb20gJ3BhcnNlL25vZGUnO1xuaW1wb3J0IEFkYXB0YWJsZUNvbnRyb2xsZXIgZnJvbSAnLi9BZGFwdGFibGVDb250cm9sbGVyJztcbmltcG9ydCB7IExvZ2dlckFkYXB0ZXIgfSBmcm9tICcuLi9BZGFwdGVycy9Mb2dnZXIvTG9nZ2VyQWRhcHRlcic7XG5pbXBvcnQgdXJsIGZyb20gJ3VybCc7XG5cbmNvbnN0IE1JTExJU0VDT05EU19JTl9BX0RBWSA9IDI0ICogNjAgKiA2MCAqIDEwMDA7XG5jb25zdCBMT0dfU1RSSU5HX1RSVU5DQVRFX0xFTkdUSCA9IDEwMDA7XG5jb25zdCB0cnVuY2F0aW9uTWFya2VyID0gJy4uLiAodHJ1bmNhdGVkKSc7XG5cbmV4cG9ydCBjb25zdCBMb2dMZXZlbCA9IHtcbiAgSU5GTzogJ2luZm8nLFxuICBFUlJPUjogJ2Vycm9yJ1xufVxuXG5leHBvcnQgY29uc3QgTG9nT3JkZXIgPSB7XG4gIERFU0NFTkRJTkc6ICdkZXNjJyxcbiAgQVNDRU5ESU5HOiAnYXNjJ1xufVxuXG5jb25zdCBsb2dMZXZlbHMgPSBbXG4gICdlcnJvcicsXG4gICd3YXJuJyxcbiAgJ2luZm8nLFxuICAnZGVidWcnLFxuICAndmVyYm9zZScsXG4gICdzaWxseScsXG5dXG5cbmV4cG9ydCBjbGFzcyBMb2dnZXJDb250cm9sbGVyIGV4dGVuZHMgQWRhcHRhYmxlQ29udHJvbGxlciB7XG5cbiAgY29uc3RydWN0b3IoYWRhcHRlciwgYXBwSWQsIG9wdGlvbnMgPSB7bG9nTGV2ZWw6ICdpbmZvJ30pIHtcbiAgICBzdXBlcihhZGFwdGVyLCBhcHBJZCwgb3B0aW9ucyk7XG4gICAgbGV0IGxldmVsID0gJ2luZm8nO1xuICAgIGlmIChvcHRpb25zLnZlcmJvc2UpIHtcbiAgICAgIGxldmVsID0gJ3ZlcmJvc2UnO1xuICAgIH1cbiAgICBpZiAob3B0aW9ucy5sb2dMZXZlbCkge1xuICAgICAgbGV2ZWwgPSBvcHRpb25zLmxvZ0xldmVsO1xuICAgIH1cbiAgICBjb25zdCBpbmRleCA9IGxvZ0xldmVscy5pbmRleE9mKGxldmVsKTsgLy8gaW5mbyBieSBkZWZhdWx0XG4gICAgbG9nTGV2ZWxzLmZvckVhY2goKGxldmVsLCBsZXZlbEluZGV4KSA9PiB7XG4gICAgICBpZiAobGV2ZWxJbmRleCA+IGluZGV4KSB7IC8vIHNpbGVuY2UgdGhlIGxldmVscyB0aGF0IGFyZSA+IG1heEluZGV4XG4gICAgICAgIHRoaXNbbGV2ZWxdID0gKCkgPT4ge307XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBtYXNrU2Vuc2l0aXZlVXJsKHVybFN0cmluZykge1xuICAgIGNvbnN0IHVybE9iaiA9IHVybC5wYXJzZSh1cmxTdHJpbmcsIHRydWUpO1xuICAgIGNvbnN0IHF1ZXJ5ID0gdXJsT2JqLnF1ZXJ5O1xuICAgIGxldCBzYW5pdGl6ZWRRdWVyeSA9ICc/JztcblxuICAgIGZvcihjb25zdCBrZXkgaW4gcXVlcnkpIHtcbiAgICAgIGlmKGtleSAhPT0gJ3Bhc3N3b3JkJykge1xuICAgICAgICAvLyBub3JtYWwgdmFsdWVcbiAgICAgICAgc2FuaXRpemVkUXVlcnkgKz0ga2V5ICsgJz0nICsgcXVlcnlba2V5XSArICcmJztcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHBhc3N3b3JkIHZhbHVlLCByZWRhY3QgaXRcbiAgICAgICAgc2FuaXRpemVkUXVlcnkgKz0ga2V5ICsgJz0nICsgJyoqKioqKioqJyArICcmJztcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyB0cmltIGxhc3QgY2hhcmFjdGVyLCA/IG9yICZcbiAgICBzYW5pdGl6ZWRRdWVyeSA9IHNhbml0aXplZFF1ZXJ5LnNsaWNlKDAsIC0xKTtcblxuICAgIC8vIHJldHVybiBvcmlnaW5hbCBwYXRoIG5hbWUgd2l0aCBzYW5pdGl6ZWQgcGFyYW1zIGF0dGFjaGVkXG4gICAgcmV0dXJuIHVybE9iai5wYXRobmFtZSArIHNhbml0aXplZFF1ZXJ5O1xuICB9XG5cbiAgbWFza1NlbnNpdGl2ZShhcmdBcnJheSkge1xuICAgIHJldHVybiBhcmdBcnJheS5tYXAoZSA9PiB7XG4gICAgICBpZiAoIWUpIHtcbiAgICAgICAgcmV0dXJuIGU7XG4gICAgICB9XG5cbiAgICAgIGlmICh0eXBlb2YgZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmV0dXJuIGUucmVwbGFjZSgvKHBhc3N3b3JkXCIuPzouP1wiKVteXCJdKlwiL2csICckMSoqKioqKioqXCInKTtcbiAgICAgIH1cbiAgICAgIC8vIGVsc2UgaXQgaXMgYW4gb2JqZWN0Li4uXG5cbiAgICAgIC8vIGNoZWNrIHRoZSB1cmxcbiAgICAgIGlmIChlLnVybCkge1xuICAgICAgICAvLyBmb3Igc3RyaW5nc1xuICAgICAgICBpZiAodHlwZW9mIGUudXJsID09PSAnc3RyaW5nJykge1xuICAgICAgICAgIGUudXJsID0gdGhpcy5tYXNrU2Vuc2l0aXZlVXJsKGUudXJsKTtcbiAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGUudXJsKSkgeyAvLyBmb3Igc3RyaW5ncyBpbiBhcnJheVxuICAgICAgICAgIGUudXJsID0gZS51cmwubWFwKGl0ZW0gPT4ge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVtID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICByZXR1cm4gdGhpcy5tYXNrU2Vuc2l0aXZlVXJsKGl0ZW0pO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gaXRlbTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAoZS5ib2R5KSB7XG4gICAgICAgIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKGUuYm9keSkpIHtcbiAgICAgICAgICBpZiAoa2V5ID09PSAncGFzc3dvcmQnKSB7XG4gICAgICAgICAgICBlLmJvZHlba2V5XSA9ICcqKioqKioqKic7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKGUucGFyYW1zKSB7XG4gICAgICAgIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKGUucGFyYW1zKSkge1xuICAgICAgICAgIGlmIChrZXkgPT09ICdwYXNzd29yZCcpIHtcbiAgICAgICAgICAgIGUucGFyYW1zW2tleV0gPSAnKioqKioqKionO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBlO1xuICAgIH0pO1xuICB9XG5cbiAgbG9nKGxldmVsLCBhcmdzKSB7XG4gICAgLy8gbWFrZSB0aGUgcGFzc2VkIGluIGFyZ3VtZW50cyBvYmplY3QgYW4gYXJyYXkgd2l0aCB0aGUgc3ByZWFkIG9wZXJhdG9yXG4gICAgYXJncyA9IHRoaXMubWFza1NlbnNpdGl2ZShbLi4uYXJnc10pO1xuICAgIGFyZ3MgPSBbXS5jb25jYXQobGV2ZWwsIGFyZ3MubWFwKChhcmcpID0+IHtcbiAgICAgIGlmICh0eXBlb2YgYXJnID09PSAnZnVuY3Rpb24nKSB7IHJldHVybiBhcmcoKTsgfVxuICAgICAgcmV0dXJuIGFyZztcbiAgICB9KSk7XG4gICAgdGhpcy5hZGFwdGVyLmxvZy5hcHBseSh0aGlzLmFkYXB0ZXIsIGFyZ3MpO1xuICB9XG5cbiAgaW5mbygpIHtcbiAgICByZXR1cm4gdGhpcy5sb2coJ2luZm8nLCBhcmd1bWVudHMpO1xuICB9XG5cbiAgZXJyb3IoKSB7XG4gICAgcmV0dXJuIHRoaXMubG9nKCdlcnJvcicsIGFyZ3VtZW50cyk7XG4gIH1cblxuICB3YXJuKCkge1xuICAgIHJldHVybiB0aGlzLmxvZygnd2FybicsIGFyZ3VtZW50cyk7XG4gIH1cblxuICB2ZXJib3NlKCkge1xuICAgIHJldHVybiB0aGlzLmxvZygndmVyYm9zZScsIGFyZ3VtZW50cyk7XG4gIH1cblxuICBkZWJ1ZygpIHtcbiAgICByZXR1cm4gdGhpcy5sb2coJ2RlYnVnJywgYXJndW1lbnRzKTtcbiAgfVxuXG4gIHNpbGx5KCkge1xuICAgIHJldHVybiB0aGlzLmxvZygnc2lsbHknLCBhcmd1bWVudHMpO1xuICB9XG5cbiAgbG9nUmVxdWVzdCh7XG4gICAgbWV0aG9kLFxuICAgIHVybCxcbiAgICBoZWFkZXJzLFxuICAgIGJvZHlcbiAgfSkge1xuICAgIHRoaXMudmVyYm9zZSgoKSA9PiB7XG4gICAgICBjb25zdCBzdHJpbmdpZmllZEJvZHkgPSBKU09OLnN0cmluZ2lmeShib2R5LCBudWxsLCAyKTtcbiAgICAgIHJldHVybiBgUkVRVUVTVCBmb3IgWyR7bWV0aG9kfV0gJHt1cmx9OiAke3N0cmluZ2lmaWVkQm9keX1gO1xuICAgIH0sIHtcbiAgICAgIG1ldGhvZCxcbiAgICAgIHVybCxcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5XG4gICAgfSk7XG4gIH1cblxuICBsb2dSZXNwb25zZSh7XG4gICAgbWV0aG9kLFxuICAgIHVybCxcbiAgICByZXN1bHRcbiAgfSkge1xuICAgIHRoaXMudmVyYm9zZShcbiAgICAgICgpID0+IHsgY29uc3Qgc3RyaW5naWZpZWRSZXNwb25zZSA9IEpTT04uc3RyaW5naWZ5KHJlc3VsdCwgbnVsbCwgMik7XG4gICAgICAgIHJldHVybiBgUkVTUE9OU0UgZnJvbSBbJHttZXRob2R9XSAke3VybH06ICR7c3RyaW5naWZpZWRSZXNwb25zZX1gO1xuICAgICAgfSxcbiAgICAgIHtyZXN1bHQ6IHJlc3VsdH1cbiAgICApO1xuICB9XG4gIC8vIGNoZWNrIHRoYXQgZGF0ZSBpbnB1dCBpcyB2YWxpZFxuICBzdGF0aWMgdmFsaWREYXRlVGltZShkYXRlKSB7XG4gICAgaWYgKCFkYXRlKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgZGF0ZSA9IG5ldyBEYXRlKGRhdGUpO1xuXG4gICAgaWYgKCFpc05hTihkYXRlLmdldFRpbWUoKSkpIHtcbiAgICAgIHJldHVybiBkYXRlO1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgdHJ1bmNhdGVMb2dNZXNzYWdlKHN0cmluZykge1xuICAgIGlmIChzdHJpbmcgJiYgc3RyaW5nLmxlbmd0aCA+IExPR19TVFJJTkdfVFJVTkNBVEVfTEVOR1RIKSB7XG4gICAgICBjb25zdCB0cnVuY2F0ZWQgPSBzdHJpbmcuc3Vic3RyaW5nKDAsIExPR19TVFJJTkdfVFJVTkNBVEVfTEVOR1RIKSArIHRydW5jYXRpb25NYXJrZXI7XG4gICAgICByZXR1cm4gdHJ1bmNhdGVkO1xuICAgIH1cblxuICAgIHJldHVybiBzdHJpbmc7XG4gIH1cblxuICBzdGF0aWMgcGFyc2VPcHRpb25zKG9wdGlvbnMgPSB7fSkge1xuICAgIGNvbnN0IGZyb20gPSBMb2dnZXJDb250cm9sbGVyLnZhbGlkRGF0ZVRpbWUob3B0aW9ucy5mcm9tKSB8fFxuICAgICAgbmV3IERhdGUoRGF0ZS5ub3coKSAtIDcgKiBNSUxMSVNFQ09ORFNfSU5fQV9EQVkpO1xuICAgIGNvbnN0IHVudGlsID0gTG9nZ2VyQ29udHJvbGxlci52YWxpZERhdGVUaW1lKG9wdGlvbnMudW50aWwpIHx8IG5ldyBEYXRlKCk7XG4gICAgY29uc3Qgc2l6ZSA9IE51bWJlcihvcHRpb25zLnNpemUpIHx8IDEwO1xuICAgIGNvbnN0IG9yZGVyID0gb3B0aW9ucy5vcmRlciB8fCBMb2dPcmRlci5ERVNDRU5ESU5HO1xuICAgIGNvbnN0IGxldmVsID0gb3B0aW9ucy5sZXZlbCB8fCBMb2dMZXZlbC5JTkZPO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGZyb20sXG4gICAgICB1bnRpbCxcbiAgICAgIHNpemUsXG4gICAgICBvcmRlcixcbiAgICAgIGxldmVsLFxuICAgIH07XG4gIH1cblxuICAvLyBSZXR1cm5zIGEgcHJvbWlzZSBmb3IgYSB7cmVzcG9uc2V9IG9iamVjdC5cbiAgLy8gcXVlcnkgcGFyYW1zOlxuICAvLyBsZXZlbCAob3B0aW9uYWwpIExldmVsIG9mIGxvZ2dpbmcgeW91IHdhbnQgdG8gcXVlcnkgZm9yIChpbmZvIHx8IGVycm9yKVxuICAvLyBmcm9tIChvcHRpb25hbCkgU3RhcnQgdGltZSBmb3IgdGhlIHNlYXJjaC4gRGVmYXVsdHMgdG8gMSB3ZWVrIGFnby5cbiAgLy8gdW50aWwgKG9wdGlvbmFsKSBFbmQgdGltZSBmb3IgdGhlIHNlYXJjaC4gRGVmYXVsdHMgdG8gY3VycmVudCB0aW1lLlxuICAvLyBvcmRlciAob3B0aW9uYWwpIERpcmVjdGlvbiBvZiByZXN1bHRzIHJldHVybmVkLCBlaXRoZXIg4oCcYXNj4oCdIG9yIOKAnGRlc2PigJ0uIERlZmF1bHRzIHRvIOKAnGRlc2PigJ0uXG4gIC8vIHNpemUgKG9wdGlvbmFsKSBOdW1iZXIgb2Ygcm93cyByZXR1cm5lZCBieSBzZWFyY2guIERlZmF1bHRzIHRvIDEwXG4gIGdldExvZ3Mob3B0aW9ucyA9IHt9KSB7XG4gICAgaWYgKCF0aGlzLmFkYXB0ZXIpIHtcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5QVVNIX01JU0NPTkZJR1VSRUQsXG4gICAgICAgICdMb2dnZXIgYWRhcHRlciBpcyBub3QgYXZhaWxhYmxlJyk7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgdGhpcy5hZGFwdGVyLnF1ZXJ5ICE9PSAnZnVuY3Rpb24nKSB7XG4gICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuUFVTSF9NSVNDT05GSUdVUkVELFxuICAgICAgICAnUXVlcnlpbmcgbG9ncyBpcyBub3Qgc3VwcG9ydGVkIHdpdGggdGhpcyBhZGFwdGVyJyk7XG4gICAgfVxuICAgIG9wdGlvbnMgPSBMb2dnZXJDb250cm9sbGVyLnBhcnNlT3B0aW9ucyhvcHRpb25zKTtcbiAgICByZXR1cm4gdGhpcy5hZGFwdGVyLnF1ZXJ5KG9wdGlvbnMpO1xuICB9XG5cbiAgZXhwZWN0ZWRBZGFwdGVyVHlwZSgpIHtcbiAgICByZXR1cm4gTG9nZ2VyQWRhcHRlcjtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBMb2dnZXJDb250cm9sbGVyO1xuIl19