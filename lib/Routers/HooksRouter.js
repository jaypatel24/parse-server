'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.HooksRouter = undefined;

var _node = require('parse/node');

var _PromiseRouter = require('../PromiseRouter');

var _PromiseRouter2 = _interopRequireDefault(_PromiseRouter);

var _middlewares = require('../middlewares');

var middleware = _interopRequireWildcard(_middlewares);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class HooksRouter extends _PromiseRouter2.default {
  createHook(aHook, config) {
    return config.hooksController.createHook(aHook).then(hook => ({ response: hook }));
  }

  updateHook(aHook, config) {
    return config.hooksController.updateHook(aHook).then(hook => ({ response: hook }));
  }

  handlePost(req) {
    return this.createHook(req.body, req.config);
  }

  handleGetFunctions(req) {
    var hooksController = req.config.hooksController;
    if (req.params.functionName) {
      return hooksController.getFunction(req.params.functionName).then(foundFunction => {
        if (!foundFunction) {
          throw new _node.Parse.Error(143, `no function named: ${req.params.functionName} is defined`);
        }
        return Promise.resolve({ response: foundFunction });
      });
    }

    return hooksController.getFunctions().then(functions => {
      return { response: functions || [] };
    }, err => {
      throw err;
    });
  }

  handleGetTriggers(req) {
    var hooksController = req.config.hooksController;
    if (req.params.className && req.params.triggerName) {

      return hooksController.getTrigger(req.params.className, req.params.triggerName).then(foundTrigger => {
        if (!foundTrigger) {
          throw new _node.Parse.Error(143, `class ${req.params.className} does not exist`);
        }
        return Promise.resolve({ response: foundTrigger });
      });
    }

    return hooksController.getTriggers().then(triggers => ({ response: triggers || [] }));
  }

  handleDelete(req) {
    var hooksController = req.config.hooksController;
    if (req.params.functionName) {
      return hooksController.deleteFunction(req.params.functionName).then(() => ({ response: {} }));
    } else if (req.params.className && req.params.triggerName) {
      return hooksController.deleteTrigger(req.params.className, req.params.triggerName).then(() => ({ response: {} }));
    }
    return Promise.resolve({ response: {} });
  }

  handleUpdate(req) {
    var hook;
    if (req.params.functionName && req.body.url) {
      hook = {};
      hook.functionName = req.params.functionName;
      hook.url = req.body.url;
    } else if (req.params.className && req.params.triggerName && req.body.url) {
      hook = {};
      hook.className = req.params.className;
      hook.triggerName = req.params.triggerName;
      hook.url = req.body.url;
    } else {
      throw new _node.Parse.Error(143, "invalid hook declaration");
    }
    return this.updateHook(hook, req.config);
  }

  handlePut(req) {
    var body = req.body;
    if (body.__op == "Delete") {
      return this.handleDelete(req);
    } else {
      return this.handleUpdate(req);
    }
  }

  mountRoutes() {
    this.route('GET', '/hooks/functions', middleware.promiseEnforceMasterKeyAccess, this.handleGetFunctions.bind(this));
    this.route('GET', '/hooks/triggers', middleware.promiseEnforceMasterKeyAccess, this.handleGetTriggers.bind(this));
    this.route('GET', '/hooks/functions/:functionName', middleware.promiseEnforceMasterKeyAccess, this.handleGetFunctions.bind(this));
    this.route('GET', '/hooks/triggers/:className/:triggerName', middleware.promiseEnforceMasterKeyAccess, this.handleGetTriggers.bind(this));
    this.route('POST', '/hooks/functions', middleware.promiseEnforceMasterKeyAccess, this.handlePost.bind(this));
    this.route('POST', '/hooks/triggers', middleware.promiseEnforceMasterKeyAccess, this.handlePost.bind(this));
    this.route('PUT', '/hooks/functions/:functionName', middleware.promiseEnforceMasterKeyAccess, this.handlePut.bind(this));
    this.route('PUT', '/hooks/triggers/:className/:triggerName', middleware.promiseEnforceMasterKeyAccess, this.handlePut.bind(this));
  }
}

exports.HooksRouter = HooksRouter;
exports.default = HooksRouter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0hvb2tzUm91dGVyLmpzIl0sIm5hbWVzIjpbIm1pZGRsZXdhcmUiLCJIb29rc1JvdXRlciIsImNyZWF0ZUhvb2siLCJhSG9vayIsImNvbmZpZyIsImhvb2tzQ29udHJvbGxlciIsInRoZW4iLCJob29rIiwicmVzcG9uc2UiLCJ1cGRhdGVIb29rIiwiaGFuZGxlUG9zdCIsInJlcSIsImJvZHkiLCJoYW5kbGVHZXRGdW5jdGlvbnMiLCJwYXJhbXMiLCJmdW5jdGlvbk5hbWUiLCJnZXRGdW5jdGlvbiIsImZvdW5kRnVuY3Rpb24iLCJFcnJvciIsIlByb21pc2UiLCJyZXNvbHZlIiwiZ2V0RnVuY3Rpb25zIiwiZnVuY3Rpb25zIiwiZXJyIiwiaGFuZGxlR2V0VHJpZ2dlcnMiLCJjbGFzc05hbWUiLCJ0cmlnZ2VyTmFtZSIsImdldFRyaWdnZXIiLCJmb3VuZFRyaWdnZXIiLCJnZXRUcmlnZ2VycyIsInRyaWdnZXJzIiwiaGFuZGxlRGVsZXRlIiwiZGVsZXRlRnVuY3Rpb24iLCJkZWxldGVUcmlnZ2VyIiwiaGFuZGxlVXBkYXRlIiwidXJsIiwiaGFuZGxlUHV0IiwiX19vcCIsIm1vdW50Um91dGVzIiwicm91dGUiLCJwcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcyIsImJpbmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7OztBQUNBOztJQUFZQSxVOzs7Ozs7QUFFTCxNQUFNQyxXQUFOLGlDQUF3QztBQUM3Q0MsYUFBV0MsS0FBWCxFQUFrQkMsTUFBbEIsRUFBMEI7QUFDeEIsV0FBT0EsT0FBT0MsZUFBUCxDQUF1QkgsVUFBdkIsQ0FBa0NDLEtBQWxDLEVBQXlDRyxJQUF6QyxDQUErQ0MsSUFBRCxLQUFXLEVBQUNDLFVBQVVELElBQVgsRUFBWCxDQUE5QyxDQUFQO0FBQ0Q7O0FBRURFLGFBQVdOLEtBQVgsRUFBa0JDLE1BQWxCLEVBQTBCO0FBQ3hCLFdBQVFBLE9BQU9DLGVBQVAsQ0FBdUJJLFVBQXZCLENBQWtD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Iiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGFyc2UgfSAgICAgICBmcm9tICdwYXJzZS9ub2RlJztcbmltcG9ydCBQcm9taXNlUm91dGVyICAgZnJvbSAnLi4vUHJvbWlzZVJvdXRlcic7XG5pbXBvcnQgKiBhcyBtaWRkbGV3YXJlIGZyb20gXCIuLi9taWRkbGV3YXJlc1wiO1xuXG5leHBvcnQgY2xhc3MgSG9va3NSb3V0ZXIgZXh0ZW5kcyBQcm9taXNlUm91dGVyIHtcbiAgY3JlYXRlSG9vayhhSG9vaywgY29uZmlnKSB7XG4gICAgcmV0dXJuIGNvbmZpZy5ob29rc0NvbnRyb2xsZXIuY3JlYXRlSG9vayhhSG9vaykudGhlbigoaG9vaykgPT4gKHtyZXNwb25zZTogaG9va30pKTtcbiAgfVxuXG4gIHVwZGF0ZUhvb2soYUhvb2ssIGNvbmZpZykge1xuICAgIHJldHVybiAgY29uZmlnLmhvb2tzQ29udHJvbGxlci51cGRhdGVIb29rKGFIb29rKS50aGVuKChob29rKSA9PiAoe3Jlc3BvbnNlOiBob29rfSkpO1xuICB9XG5cbiAgaGFuZGxlUG9zdChyZXEpIHtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVIb29rKHJlcS5ib2R5LCByZXEuY29uZmlnKTtcbiAgfVxuXG4gIGhhbmRsZUdldEZ1bmN0aW9ucyhyZXEpIHtcbiAgICB2YXIgaG9va3NDb250cm9sbGVyID0gcmVxLmNvbmZpZy5ob29rc0NvbnRyb2xsZXI7XG4gICAgaWYgKHJlcS5wYXJhbXMuZnVuY3Rpb25OYW1lKSB7XG4gICAgICByZXR1cm4gaG9va3NDb250cm9sbGVyLmdldEZ1bmN0aW9uKHJlcS5wYXJhbXMuZnVuY3Rpb25OYW1lKS50aGVuKChmb3VuZEZ1bmN0aW9uKSA9PiB7XG4gICAgICAgIGlmICghZm91bmRGdW5jdGlvbikge1xuICAgICAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcigxNDMsIGBubyBmdW5jdGlvbiBuYW1lZDogJHtyZXEucGFyYW1zLmZ1bmN0aW9uTmFtZX0gaXMgZGVmaW5lZGApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe3Jlc3BvbnNlOiBmb3VuZEZ1bmN0aW9ufSk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gaG9va3NDb250cm9sbGVyLmdldEZ1bmN0aW9ucygpLnRoZW4oKGZ1bmN0aW9ucykgPT4ge1xuICAgICAgcmV0dXJuIHsgcmVzcG9uc2U6IGZ1bmN0aW9ucyB8fCBbXSB9O1xuICAgIH0sIChlcnIpID0+IHtcbiAgICAgIHRocm93IGVycjtcbiAgICB9KTtcbiAgfVxuXG4gIGhhbmRsZUdldFRyaWdnZXJzKHJlcSkge1xuICAgIHZhciBob29rc0NvbnRyb2xsZXIgPSByZXEuY29uZmlnLmhvb2tzQ29udHJvbGxlcjtcbiAgICBpZiAocmVxLnBhcmFtcy5jbGFzc05hbWUgJiYgcmVxLnBhcmFtcy50cmlnZ2VyTmFtZSkge1xuXG4gICAgICByZXR1cm4gaG9va3NDb250cm9sbGVyLmdldFRyaWdnZXIocmVxLnBhcmFtcy5jbGFzc05hbWUsIHJlcS5wYXJhbXMudHJpZ2dlck5hbWUpLnRoZW4oKGZvdW5kVHJpZ2dlcikgPT4ge1xuICAgICAgICBpZiAoIWZvdW5kVHJpZ2dlcikge1xuICAgICAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcigxNDMsYGNsYXNzICR7cmVxLnBhcmFtcy5jbGFzc05hbWV9IGRvZXMgbm90IGV4aXN0YCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7cmVzcG9uc2U6IGZvdW5kVHJpZ2dlcn0pO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGhvb2tzQ29udHJvbGxlci5nZXRUcmlnZ2VycygpLnRoZW4oKHRyaWdnZXJzKSA9PiAoeyByZXNwb25zZTogdHJpZ2dlcnMgfHwgW10gfSkpO1xuICB9XG5cbiAgaGFuZGxlRGVsZXRlKHJlcSkge1xuICAgIHZhciBob29rc0NvbnRyb2xsZXIgPSByZXEuY29uZmlnLmhvb2tzQ29udHJvbGxlcjtcbiAgICBpZiAocmVxLnBhcmFtcy5mdW5jdGlvbk5hbWUpIHtcbiAgICAgIHJldHVybiBob29rc0NvbnRyb2xsZXIuZGVsZXRlRnVuY3Rpb24ocmVxLnBhcmFtcy5mdW5jdGlvbk5hbWUpLnRoZW4oKCkgPT4gKHtyZXNwb25zZToge319KSlcblxuICAgIH0gZWxzZSBpZiAocmVxLnBhcmFtcy5jbGFzc05hbWUgJiYgcmVxLnBhcmFtcy50cmlnZ2VyTmFtZSkge1xuICAgICAgcmV0dXJuIGhvb2tzQ29udHJvbGxlci5kZWxldGVUcmlnZ2VyKHJlcS5wYXJhbXMuY2xhc3NOYW1lLCByZXEucGFyYW1zLnRyaWdnZXJOYW1lKS50aGVuKCgpID0+ICh7cmVzcG9uc2U6IHt9fSkpXG4gICAgfVxuICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe3Jlc3BvbnNlOiB7fX0pO1xuICB9XG5cbiAgaGFuZGxlVXBkYXRlKHJlcSkge1xuICAgIHZhciBob29rO1xuICAgIGlmIChyZXEucGFyYW1zLmZ1bmN0aW9uTmFtZSAmJiByZXEuYm9keS51cmwpIHtcbiAgICAgIGhvb2sgPSB7fVxuICAgICAgaG9vay5mdW5jdGlvbk5hbWUgPSByZXEucGFyYW1zLmZ1bmN0aW9uTmFtZTtcbiAgICAgIGhvb2sudXJsID0gcmVxLmJvZHkudXJsO1xuICAgIH0gZWxzZSBpZiAocmVxLnBhcmFtcy5jbGFzc05hbWUgJiYgcmVxLnBhcmFtcy50cmlnZ2VyTmFtZSAmJiByZXEuYm9keS51cmwpIHtcbiAgICAgIGhvb2sgPSB7fVxuICAgICAgaG9vay5jbGFzc05hbWUgPSByZXEucGFyYW1zLmNsYXNzTmFtZTtcbiAgICAgIGhvb2sudHJpZ2dlck5hbWUgPSByZXEucGFyYW1zLnRyaWdnZXJOYW1lO1xuICAgICAgaG9vay51cmwgPSByZXEuYm9keS51cmxcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKDE0MywgXCJpbnZhbGlkIGhvb2sgZGVjbGFyYXRpb25cIik7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnVwZGF0ZUhvb2soaG9vaywgcmVxLmNvbmZpZyk7XG4gIH1cblxuICBoYW5kbGVQdXQocmVxKSB7XG4gICAgdmFyIGJvZHkgPSByZXEuYm9keTtcbiAgICBpZiAoYm9keS5fX29wID09IFwiRGVsZXRlXCIpIHtcbiAgICAgIHJldHVybiB0aGlzLmhhbmRsZURlbGV0ZShyZXEpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdGhpcy5oYW5kbGVVcGRhdGUocmVxKTtcbiAgICB9XG4gIH1cblxuICBtb3VudFJvdXRlcygpIHtcbiAgICB0aGlzLnJvdXRlKCdHRVQnLCAgJy9ob29rcy9mdW5jdGlvbnMnLCBtaWRkbGV3YXJlLnByb21pc2VFbmZvcmNlTWFzdGVyS2V5QWNjZXNzLCB0aGlzLmhhbmRsZUdldEZ1bmN0aW9ucy5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLnJvdXRlKCdHRVQnLCAgJy9ob29rcy90cmlnZ2VycycsIG1pZGRsZXdhcmUucHJvbWlzZUVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MsIHRoaXMuaGFuZGxlR2V0VHJpZ2dlcnMuYmluZCh0aGlzKSk7XG4gICAgdGhpcy5yb3V0ZSgnR0VUJywgICcvaG9va3MvZnVuY3Rpb25zLzpmdW5jdGlvbk5hbWUnLCBtaWRkbGV3YXJlLnByb21pc2VFbmZvcmNlTWFzdGVyS2V5QWNjZXNzLCB0aGlzLmhhbmRsZUdldEZ1bmN0aW9ucy5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLnJvdXRlKCdHRVQnLCAgJy9ob29rcy90cmlnZ2Vycy86Y2xhc3NOYW1lLzp0cmlnZ2VyTmFtZScsIG1pZGRsZXdhcmUucHJvbWlzZUVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MsIHRoaXMuaGFuZGxlR2V0VHJpZ2dlcnMuYmluZCh0aGlzKSk7XG4gICAgdGhpcy5yb3V0ZSgnUE9TVCcsICcvaG9va3MvZnVuY3Rpb25zJywgbWlkZGxld2FyZS5wcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcywgdGhpcy5oYW5kbGVQb3N0LmJpbmQodGhpcykpO1xuICAgIHRoaXMucm91dGUoJ1BPU1QnLCAnL2hvb2tzL3RyaWdnZXJzJywgbWlkZGxld2FyZS5wcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcywgdGhpcy5oYW5kbGVQb3N0LmJpbmQodGhpcykpO1xuICAgIHRoaXMucm91dGUoJ1BVVCcsICAnL2hvb2tzL2Z1bmN0aW9ucy86ZnVuY3Rpb25OYW1lJywgbWlkZGxld2FyZS5wcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcywgdGhpcy5oYW5kbGVQdXQuYmluZCh0aGlzKSk7XG4gICAgdGhpcy5yb3V0ZSgnUFVUJywgICcvaG9va3MvdHJpZ2dlcnMvOmNsYXNzTmFtZS86dHJpZ2dlck5hbWUnLCBtaWRkbGV3YXJlLnByb21pc2VFbmZvcmNlTWFzdGVyS2V5QWNjZXNzLCB0aGlzLmhhbmRsZVB1dC5iaW5kKHRoaXMpKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBIb29rc1JvdXRlcjtcbiJdfQ==