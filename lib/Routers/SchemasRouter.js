'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SchemasRouter = undefined;

var _PromiseRouter = require('../PromiseRouter');

var _PromiseRouter2 = _interopRequireDefault(_PromiseRouter);

var _middlewares = require('../middlewares');

var middleware = _interopRequireWildcard(_middlewares);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// schemas.js

var Parse = require('parse/node').Parse,
    SchemaController = require('../Controllers/SchemaController');

function classNameMismatchResponse(bodyClass, pathClass) {
  throw new Parse.Error(Parse.Error.INVALID_CLASS_NAME, `Class name mismatch between ${bodyClass} and ${pathClass}.`);
}

function getAllSchemas(req) {
  return req.config.database.loadSchema({ clearCache: true }).then(schemaController => schemaController.getAllClasses(true)).then(schemas => ({ response: { results: schemas } }));
}

function getOneSchema(req) {
  const className = req.params.className;
  return req.config.database.loadSchema({ clearCache: true }).then(schemaController => schemaController.getOneSchema(className, true)).then(schema => ({ response: schema })).catch(error => {
    if (error === undefined) {
      throw new Parse.Error(Parse.Error.INVALID_CLASS_NAME, `Class ${className} does not exist.`);
    } else {
      throw new Parse.Error(Parse.Error.INTERNAL_SERVER_ERROR, 'Database adapter error.');
    }
  });
}

function createSchema(req) {
  if (req.auth.isReadOnly) {
    throw new Parse.Error(Parse.Error.OPERATION_FORBIDDEN, 'read-only masterKey isn\'t allowed to create a schema.');
  }
  if (req.params.className && req.body.className) {
    if (req.params.className != req.body.className) {
      return classNameMismatchResponse(req.body.className, req.params.className);
    }
  }

  const className = req.params.className || req.body.className;
  if (!className) {
    throw new Parse.Error(135, `POST ${req.path} needs a class name.`);
  }

  return req.config.database.loadSchema({ clearCache: true }).then(schema => schema.addClassIfNotExists(className, req.body.fields, req.body.classLevelPermissions, req.body.indexes)).then(schema => ({ response: schema }));
}

function modifySchema(req) {
  if (req.auth.isReadOnly) {
    throw new Parse.Error(Parse.Error.OPERATION_FORBIDDEN, 'read-only masterKey isn\'t allowed to update a schema.');
  }
  if (req.body.className && req.body.className != req.params.className) {
    return classNameMismatchResponse(req.body.className, req.params.className);
  }

  const submittedFields = req.body.fields || {};
  const className = req.params.className;

  return req.config.database.loadSchema({ clearCache: true }).then(schema => schema.updateClass(className, submittedFields, req.body.classLevelPermissions, req.body.indexes, req.config.database)).then(result => ({ response: result }));
}

const deleteSchema = req => {
  if (req.auth.isReadOnly) {
    throw new Parse.Error(Parse.Error.OPERATION_FORBIDDEN, 'read-only masterKey isn\'t allowed to delete a schema.');
  }
  if (!SchemaController.classNameIsValid(req.params.className)) {
    throw new Parse.Error(Parse.Error.INVALID_CLASS_NAME, SchemaController.invalidClassNameMessage(req.params.className));
  }
  return req.config.database.deleteSchema(req.params.className).then(() => ({ response: {} }));
};

class SchemasRouter extends _PromiseRouter2.default {
  mountRoutes() {
    this.route('GET', '/schemas', middleware.promiseEnforceMasterKeyAccess, getAllSchemas);
    this.route('GET', '/schemas/:className', middleware.promiseEnforceMasterKeyAccess, getOneSchema);
    this.route('POST', '/schemas', middleware.promiseEnforceMasterKeyAccess, createSchema);
    this.route('POST', '/schemas/:className', middleware.promiseEnforceMasterKeyAccess, createSchema);
    this.route('PUT', '/schemas/:className', middleware.promiseEnforceMasterKeyAccess, modifySchema);
    this.route('DELETE', '/schemas/:className', middleware.promiseEnforceMasterKeyAccess, deleteSchema);
  }
}
exports.SchemasRouter = SchemasRouter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL1NjaGVtYXNSb3V0ZXIuanMiXSwibmFtZXMiOlsibWlkZGxld2FyZSIsIlBhcnNlIiwicmVxdWlyZSIsIlNjaGVtYUNvbnRyb2xsZXIiLCJjbGFzc05hbWVNaXNtYXRjaFJlc3BvbnNlIiwiYm9keUNsYXNzIiwicGF0aENsYXNzIiwiRXJyb3IiLCJJTlZBTElEX0NMQVNTX05BTUUiLCJnZXRBbGxTY2hlbWFzIiwicmVxIiwiY29uZmlnIiwiZGF0YWJhc2UiLCJsb2FkU2NoZW1hIiwiY2xlYXJDYWNoZSIsInRoZW4iLCJzY2hlbWFDb250cm9sbGVyIiwiZ2V0QWxsQ2xhc3NlcyIsInNjaGVtYXMiLCJyZXNwb25zZSIsInJlc3VsdHMiLCJnZXRPbmVTY2hlbWEiLCJjbGFzc05hbWUiLCJwYXJhbXMiLCJzY2hlbWEiLCJjYXRjaCIsImVycm9yIiwidW5kZWZpbmVkIiwiSU5URVJOQUxfU0VSVkVSX0VSUk9SIiwiY3JlYXRlU2NoZW1hIiwiYXV0aCIsImlzUmVhZE9ubHkiLCJPUEVSQVRJT05fRk9SQklEREVOIiwiYm9keSIsInBhdGgiLCJhZGRDbGFzc0lmTm90RXhpc3RzIiwiZmllbGRzIiwiY2xhc3NMZXZlbFBlcm1pc3Npb25zIiwiaW5kZXhlcyIsIm1vZGlmeVNjaGVtYSIsInN1Ym1pdHRlZEZpZWxkcyIsInVwZGF0ZUNsYXNzIiwicmVzdWx0IiwiZGVsZXRlU2NoZW1hIiwiY2xhc3NOYW1lSXNWYWxpZCIsImludmFsaWRDbGFzc05hbWVNZXNzYWdlIiwiU2NoZW1hc1JvdXRlciIsIm1vdW50Um91dGVzIiwicm91dGUiLCJwcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUtBOzs7O0FBQ0E7O0lBQVlBLFU7Ozs7OztBQU5aOztBQUVBLElBQUlDLFFBQVFDLFFBQVEsWUFBUixFQUFzQkQsS0FBbEM7QUFBQSxJQUNFRSxtQkFBbUJELFFBQVEsaUNBQVIsQ0FEckI7O0FBTUEsU0FB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PSByZXF1aXJlKCdwYXJzZS9ub2RlJykuUGFyc2UsXG4gIFNjaGVtYUNvbnRyb2xsZXIgPSByZXF1aXJlKCcuLi9Db250cm9sbGVycy9TY2hlbWFDb250cm9sbGVyJyk7XG5cbmltcG9ydCBQcm9taXNlUm91dGVyICAgZnJvbSAnLi4vUHJvbWlzZVJvdXRlcic7XG5pbXBvcnQgKiBhcyBtaWRkbGV3YXJlIGZyb20gXCIuLi9taWRkbGV3YXJlc1wiO1xuXG5mdW5jdGlvbiBjbGFzc05hbWVNaXNtYXRjaFJlc3BvbnNlKGJvZHlDbGFzcywgcGF0aENsYXNzKSB7XG4gIHRocm93IG5ldyBQYXJzZS5FcnJvcihcbiAgICBQYXJzZS5FcnJvci5JTlZBTElEX0NMQVNTX05BTUUsXG4gICAgYENsYXNzIG5hbWUgbWlzbWF0Y2ggYmV0d2VlbiAke2JvZHlDbGFzc30gYW5kICR7cGF0aENsYXNzfS5gXG4gICk7XG59XG5cbmZ1bmN0aW9uIGdldEFsbFNjaGVtYXMocmVxKSB7XG4gIHJldHVybiByZXEuY29uZmlnLmRhdGFiYXNlLmxvYWRTY2hlbWEoeyBjbGVhckNhY2hlOiB0cnVlfSlcbiAgICAudGhlbihzY2hlbWFDb250cm9sbGVyID0+IHNjaGVtYUNvbnRyb2xsZXIuZ2V0QWxsQ2xhc3Nlcyh0cnVlKSlcbiAgICAudGhlbihzY2hlbWFzID0+ICh7IHJlc3BvbnNlOiB7IHJlc3VsdHM6IHNjaGVtYXMgfSB9KSk7XG59XG5cbmZ1bmN0aW9uIGdldE9uZVNjaGVtYShyZXEpIHtcbiAgY29uc3QgY2xhc3NOYW1lID0gcmVxLnBhcmFtcy5jbGFzc05hbWU7XG4gIHJldHVybiByZXEuY29uZmlnLmRhdGFiYXNlLmxvYWRTY2hlbWEoeyBjbGVhckNhY2hlOiB0cnVlfSlcbiAgICAudGhlbihzY2hlbWFDb250cm9sbGVyID0+IHNjaGVtYUNvbnRyb2xsZXIuZ2V0T25lU2NoZW1hKGNsYXNzTmFtZSwgdHJ1ZSkpXG4gICAgLnRoZW4oc2NoZW1hID0+ICh7IHJlc3BvbnNlOiBzY2hlbWEgfSkpXG4gICAgLmNhdGNoKGVycm9yID0+IHtcbiAgICAgIGlmIChlcnJvciA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5JTlZBTElEX0NMQVNTX05BTUUsIGBDbGFzcyAke2NsYXNzTmFtZX0gZG9lcyBub3QgZXhpc3QuYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuSU5URVJOQUxfU0VSVkVSX0VSUk9SLCAnRGF0YWJhc2UgYWRhcHRlciBlcnJvci4nKTtcbiAgICAgIH1cbiAgICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlU2NoZW1hKHJlcSkge1xuICBpZiAocmVxLmF1dGguaXNSZWFkT25seSkge1xuICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5PUEVSQVRJT05fRk9SQklEREVOLCAncmVhZC1vbmx5IG1hc3RlcktleSBpc25cXCd0IGFsbG93ZWQgdG8gY3JlYXRlIGEgc2NoZW1hLicpO1xuICB9XG4gIGlmIChyZXEucGFyYW1zLmNsYXNzTmFtZSAmJiByZXEuYm9keS5jbGFzc05hbWUpIHtcbiAgICBpZiAocmVxLnBhcmFtcy5jbGFzc05hbWUgIT0gcmVxLmJvZHkuY2xhc3NOYW1lKSB7XG4gICAgICByZXR1cm4gY2xhc3NOYW1lTWlzbWF0Y2hSZXNwb25zZShyZXEuYm9keS5jbGFzc05hbWUsIHJlcS5wYXJhbXMuY2xhc3NOYW1lKTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBjbGFzc05hbWUgPSByZXEucGFyYW1zLmNsYXNzTmFtZSB8fCByZXEuYm9keS5jbGFzc05hbWU7XG4gIGlmICghY2xhc3NOYW1lKSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKDEzNSwgYFBPU1QgJHtyZXEucGF0aH0gbmVlZHMgYSBjbGFzcyBuYW1lLmApO1xuICB9XG5cbiAgcmV0dXJuIHJlcS5jb25maWcuZGF0YWJhc2UubG9hZFNjaGVtYSh7IGNsZWFyQ2FjaGU6IHRydWV9KVxuICAgIC50aGVuKHNjaGVtYSA9PiBzY2hlbWEuYWRkQ2xhc3NJZk5vdEV4aXN0cyhjbGFzc05hbWUsIHJlcS5ib2R5LmZpZWxkcywgcmVxLmJvZHkuY2xhc3NMZXZlbFBlcm1pc3Npb25zLCByZXEuYm9keS5pbmRleGVzKSlcbiAgICAudGhlbihzY2hlbWEgPT4gKHsgcmVzcG9uc2U6IHNjaGVtYSB9KSk7XG59XG5cbmZ1bmN0aW9uIG1vZGlmeVNjaGVtYShyZXEpIHtcbiAgaWYgKHJlcS5hdXRoLmlzUmVhZE9ubHkpIHtcbiAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuT1BFUkFUSU9OX0ZPUkJJRERFTiwgJ3JlYWQtb25seSBtYXN0ZXJLZXkgaXNuXFwndCBhbGxvd2VkIHRvIHVwZGF0ZSBhIHNjaGVtYS4nKTtcbiAgfVxuICBpZiAocmVxLmJvZHkuY2xhc3NOYW1lICYmIHJlcS5ib2R5LmNsYXNzTmFtZSAhPSByZXEucGFyYW1zLmNsYXNzTmFtZSkge1xuICAgIHJldHVybiBjbGFzc05hbWVNaXNtYXRjaFJlc3BvbnNlKHJlcS5ib2R5LmNsYXNzTmFtZSwgcmVxLnBhcmFtcy5jbGFzc05hbWUpO1xuICB9XG5cbiAgY29uc3Qgc3VibWl0dGVkRmllbGRzID0gcmVxLmJvZHkuZmllbGRzIHx8IHt9O1xuICBjb25zdCBjbGFzc05hbWUgPSByZXEucGFyYW1zLmNsYXNzTmFtZTtcblxuICByZXR1cm4gcmVxLmNvbmZpZy5kYXRhYmFzZS5sb2FkU2NoZW1hKHsgY2xlYXJDYWNoZTogdHJ1ZX0pXG4gICAgLnRoZW4oc2NoZW1hID0+IHNjaGVtYS51cGRhdGVDbGFzcyhjbGFzc05hbWUsIHN1Ym1pdHRlZEZpZWxkcywgcmVxLmJvZHkuY2xhc3NMZXZlbFBlcm1pc3Npb25zLCByZXEuYm9keS5pbmRleGVzLCByZXEuY29uZmlnLmRhdGFiYXNlKSlcbiAgICAudGhlbihyZXN1bHQgPT4gKHtyZXNwb25zZTogcmVzdWx0fSkpO1xufVxuXG5jb25zdCBkZWxldGVTY2hlbWEgPSByZXEgPT4ge1xuICBpZiAocmVxLmF1dGguaXNSZWFkT25seSkge1xuICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5PUEVSQVRJT05fRk9SQklEREVOLCAncmVhZC1vbmx5IG1hc3RlcktleSBpc25cXCd0IGFsbG93ZWQgdG8gZGVsZXRlIGEgc2NoZW1hLicpO1xuICB9XG4gIGlmICghU2NoZW1hQ29udHJvbGxlci5jbGFzc05hbWVJc1ZhbGlkKHJlcS5wYXJhbXMuY2xhc3NOYW1lKSkge1xuICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5JTlZBTElEX0NMQVNTX05BTUUsIFNjaGVtYUNvbnRyb2xsZXIuaW52YWxpZENsYXNzTmFtZU1lc3NhZ2UocmVxLnBhcmFtcy5jbGFzc05hbWUpKTtcbiAgfVxuICByZXR1cm4gcmVxLmNvbmZpZy5kYXRhYmFzZS5kZWxldGVTY2hlbWEocmVxLnBhcmFtcy5jbGFzc05hbWUpXG4gICAgLnRoZW4oKCkgPT4gKHsgcmVzcG9uc2U6IHt9IH0pKTtcbn1cblxuZXhwb3J0IGNsYXNzIFNjaGVtYXNSb3V0ZXIgZXh0ZW5kcyBQcm9taXNlUm91dGVyIHtcbiAgbW91bnRSb3V0ZXMoKSB7XG4gICAgdGhpcy5yb3V0ZSgnR0VUJywgJy9zY2hlbWFzJywgbWlkZGxld2FyZS5wcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcywgZ2V0QWxsU2NoZW1hcyk7XG4gICAgdGhpcy5yb3V0ZSgnR0VUJywgJy9zY2hlbWFzLzpjbGFzc05hbWUnLCBtaWRkbGV3YXJlLnByb21pc2VFbmZvcmNlTWFzdGVyS2V5QWNjZXNzLCBnZXRPbmVTY2hlbWEpO1xuICAgIHRoaXMucm91dGUoJ1BPU1QnLCAnL3NjaGVtYXMnLCBtaWRkbGV3YXJlLnByb21pc2VFbmZvcmNlTWFzdGVyS2V5QWNjZXNzLCBjcmVhdGVTY2hlbWEpO1xuICAgIHRoaXMucm91dGUoJ1BPU1QnLCAnL3NjaGVtYXMvOmNsYXNzTmFtZScsIG1pZGRsZXdhcmUucHJvbWlzZUVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MsIGNyZWF0ZVNjaGVtYSk7XG4gICAgdGhpcy5yb3V0ZSgnUFVUJywgJy9zY2hlbWFzLzpjbGFzc05hbWUnLCBtaWRkbGV3YXJlLnByb21pc2VFbmZvcmNlTWFzdGVyS2V5QWNjZXNzLCBtb2RpZnlTY2hlbWEpO1xuICAgIHRoaXMucm91dGUoJ0RFTEVURScsICcvc2NoZW1hcy86Y2xhc3NOYW1lJywgbWlkZGxld2FyZS5wcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcywgZGVsZXRlU2NoZW1hKTtcbiAgfVxufVxuIl19